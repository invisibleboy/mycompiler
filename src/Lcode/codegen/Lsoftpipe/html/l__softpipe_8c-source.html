<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libsoftpipe: l_softpipe.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<h1>l_softpipe.c</h1><a href="l__softpipe_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*****************************************************************************\</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> *                    Illinois Open Source License</span>
<a name="l00004"></a>00004 <span class="comment"> *                     University of Illinois/NCSA</span>
<a name="l00005"></a>00005 <span class="comment"> *                         Open Source License</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * Copyright (c) 2004, The University of Illinois at Urbana-Champaign.</span>
<a name="l00008"></a>00008 <span class="comment"> * All rights reserved.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * Developed by:             </span>
<a name="l00011"></a>00011 <span class="comment"> *</span>
<a name="l00012"></a>00012 <span class="comment"> *              IMPACT Research Group</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> *              University of Illinois at Urbana-Champaign</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> *              http://www.crhc.uiuc.edu/IMPACT</span>
<a name="l00017"></a>00017 <span class="comment"> *              http://www.gelato.org</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * Permission is hereby granted, free of charge, to any person</span>
<a name="l00020"></a>00020 <span class="comment"> * obtaining a copy of this software and associated documentation</span>
<a name="l00021"></a>00021 <span class="comment"> * files (the "Software"), to deal with the Software without</span>
<a name="l00022"></a>00022 <span class="comment"> * restriction, including without limitation the rights to use, copy,</span>
<a name="l00023"></a>00023 <span class="comment"> * modify, merge, publish, distribute, sublicense, and/or sell copies</span>
<a name="l00024"></a>00024 <span class="comment"> * of the Software, and to permit persons to whom the Software is</span>
<a name="l00025"></a>00025 <span class="comment"> * furnished to do so, subject to the following conditions:</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> * Redistributions of source code must retain the above copyright</span>
<a name="l00028"></a>00028 <span class="comment"> * notice, this list of conditions and the following disclaimers.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * Redistributions in binary form must reproduce the above copyright</span>
<a name="l00031"></a>00031 <span class="comment"> * notice, this list of conditions and the following disclaimers in</span>
<a name="l00032"></a>00032 <span class="comment"> * the documentation and/or other materials provided with the</span>
<a name="l00033"></a>00033 <span class="comment"> * distribution.</span>
<a name="l00034"></a>00034 <span class="comment"> *</span>
<a name="l00035"></a>00035 <span class="comment"> * Neither the names of the IMPACT Research Group, the University of</span>
<a name="l00036"></a>00036 <span class="comment"> * Illinois, nor the names of its contributors may be used to endorse</span>
<a name="l00037"></a>00037 <span class="comment"> * or promote products derived from this Software without specific</span>
<a name="l00038"></a>00038 <span class="comment"> * prior written permission.  THE SOFTWARE IS PROVIDED "AS IS",</span>
<a name="l00039"></a>00039 <span class="comment"> * WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT</span>
<a name="l00040"></a>00040 <span class="comment"> * LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A</span>
<a name="l00041"></a>00041 <span class="comment"> * PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE</span>
<a name="l00042"></a>00042 <span class="comment"> * CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES</span>
<a name="l00043"></a>00043 <span class="comment"> * OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR</span>
<a name="l00044"></a>00044 <span class="comment"> * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE</span>
<a name="l00045"></a>00045 <span class="comment"> * OR THE USE OR OTHER DEALINGS WITH THE SOFTWARE.</span>
<a name="l00046"></a>00046 <span class="comment"> *</span>
<a name="l00047"></a>00047 <span class="comment">\*****************************************************************************/</span>
<a name="l00048"></a>00048 <span class="comment">/*****************************************************************************\</span>
<a name="l00049"></a>00049 <span class="comment"> *      File: l_softpipe.c</span>
<a name="l00050"></a>00050 <span class="comment"> *      Description: Modulo scheduler</span>
<a name="l00051"></a>00051 <span class="comment"> *      Creation Date: January, 1994</span>
<a name="l00052"></a>00052 <span class="comment"> *      Author: Daniel Lavery</span>
<a name="l00053"></a>00053 <span class="comment"> *</span>
<a name="l00054"></a>00054 <span class="comment"> *      Revision Date: Summer 1999</span>
<a name="l00055"></a>00055 <span class="comment"> *      Authors: IMPACT Technologies: Matthew Merten and John Gyllenhaal</span>
<a name="l00056"></a>00056 <span class="comment">\*****************************************************************************/</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="comment">/* 10/29/02 REK Adding config.h */</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &lt;config.h&gt;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include "<a class="code" href="l__softpipe__int_8h.html">l_softpipe_int.h</a>"</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include "<a class="code" href="l__softpipe_8h.html">l_softpipe.h</a>"</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include "<a class="code" href="l__pipe__sched_8h.html">l_pipe_sched.h</a>"</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include "<a class="code" href="l__pipe__sync_8h.html">l_pipe_sync.h</a>"</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include "<a class="code" href="l__pipe__rename_8h.html">l_pipe_rename.h</a>"</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include "<a class="code" href="l__mve_8h.html">l_mve.h</a>"</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &lt;Lcode/r_regalloc.h&gt;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &lt;Lcode/l_opti.h&gt;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &lt;Lcode/l_disjvreg.h&gt;</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="comment">/*************************************************************************</span>
<a name="l00071"></a>00071 <span class="comment">                Defines</span>
<a name="l00072"></a>00072 <span class="comment">*************************************************************************/</span>
<a name="l00073"></a>00073 
<a name="l00074"></a><a class="code" href="l__softpipe_8c.html#fd63d23830ad86d01b6fff2e6c615f7e">00074</a> <span class="preprocessor">#define MAX_TRIES 100           </span><span class="comment">/* Upper bound on the of candidate</span>
<a name="l00075"></a>00075 <span class="comment">                                   II's to try before giving up */</span>
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="comment">/*************************************************************************</span>
<a name="l00078"></a>00078 <span class="comment">                Global Variables</span>
<a name="l00079"></a>00079 <span class="comment">*************************************************************************/</span>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="comment">/* global variables - see l_softpipe.h */</span>
<a name="l00082"></a>00082 
<a name="l00083"></a><a class="code" href="l__softpipe__int_8h.html#91e84fa9645e4d3beb7b8b6c150da74b">00083</a> L_Cb *<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>;
<a name="l00084"></a><a class="code" href="l__softpipe__int_8h.html#4ee6d00e67672cc9a04b6f5f533bfb72">00084</a> L_Cb *<a class="code" href="l__softpipe_8c.html#4ee6d00e67672cc9a04b6f5f533bfb72">preheader_cb</a>;
<a name="l00085"></a><a class="code" href="l__softpipe__int_8h.html#4708e528902bf49b9c374df3e644309d">00085</a> L_Cb *<a class="code" href="l__softpipe_8c.html#4708e528902bf49b9c374df3e644309d">prologue_cb</a>;
<a name="l00086"></a><a class="code" href="l__softpipe__int_8h.html#785a1b69c62478bf5624354abd3955e1">00086</a> L_Cb *<a class="code" href="l__softpipe_8c.html#785a1b69c62478bf5624354abd3955e1">remainder_cb</a>;
<a name="l00087"></a><a class="code" href="l__softpipe__int_8h.html#e9b3310fa8a82cd6903c833cef98effd">00087</a> <span class="keywordtype">int</span> <a class="code" href="l__softpipe_8c.html#e9b3310fa8a82cd6903c833cef98effd">Lpipe_stage_count</a>;
<a name="l00088"></a><a class="code" href="l__softpipe__int_8h.html#e41610bb03edbaeb7c02cfcc7fc4467b">00088</a> <span class="keywordtype">int</span> <a class="code" href="l__softpipe_8c.html#e41610bb03edbaeb7c02cfcc7fc4467b">Lpipe_counted_loop</a> = 0;
<a name="l00089"></a>00089 
<a name="l00090"></a><a class="code" href="l__softpipe__int_8h.html#43dd5bc461bab37b4dc35075227b76df">00090</a> L_Oper **<a class="code" href="l__softpipe_8c.html#43dd5bc461bab37b4dc35075227b76df">kernel_copy_last_op</a> = 0;
<a name="l00091"></a><a class="code" href="l__softpipe__int_8h.html#394714920d405996c9ac56376596536a">00091</a> L_Oper **<a class="code" href="l__softpipe_8c.html#394714920d405996c9ac56376596536a">kernel_copy_first_op</a> = 0;
<a name="l00092"></a>00092 
<a name="l00093"></a><a class="code" href="l__softpipe__int_8h.html#4dc68702d9b52f9ccb3dc704c3382dad">00093</a> <span class="keywordtype">int</span> <a class="code" href="l__softpipe_8c.html#4dc68702d9b52f9ccb3dc704c3382dad">loop_dep_height</a> = -1;
<a name="l00094"></a><a class="code" href="l__softpipe__int_8h.html#377860f550eb8f35543d1b7c4a931268">00094</a> <span class="keywordtype">int</span> <a class="code" href="l__softpipe_8c.html#377860f550eb8f35543d1b7c4a931268">Lpipe_total_issue_slots</a> = -1;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="comment">/*************************************************************************</span>
<a name="l00097"></a>00097 <span class="comment">                Global FILE Variables</span>
<a name="l00098"></a>00098 <span class="comment">*************************************************************************/</span>
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 <span class="comment">/* Scheduled code output */</span>
<a name="l00101"></a><a class="code" href="l__softpipe__int_8h.html#dfcefa1a772012ef80d3b8f14f3f150b">00101</a> FILE *<a class="code" href="l__softpipe_8c.html#dfcefa1a772012ef80d3b8f14f3f150b">sched_file</a> = NULL;
<a name="l00102"></a>00102 <span class="comment">/* file to which to print stats when checking if loop can be</span>
<a name="l00103"></a>00103 <span class="comment">   software pipelined */</span>
<a name="l00104"></a><a class="code" href="l__softpipe_8c.html#d4ad2d89187dec7ea2bbf365f1e10e1e">00104</a> FILE *<a class="code" href="l__softpipe_8c.html#d4ad2d89187dec7ea2bbf365f1e10e1e">pipe_statfile</a> = NULL;
<a name="l00105"></a>00105 <span class="comment">/* file to which to print pipelining stats */</span>
<a name="l00106"></a><a class="code" href="l__softpipe_8c.html#bfb992b8633f7de2f771384a01c7411e">00106</a> FILE *<a class="code" href="l__softpipe_8c.html#bfb992b8633f7de2f771384a01c7411e">gen_statfile</a> = NULL;
<a name="l00107"></a>00107 <span class="comment">/* file to which to print average iters for each loop before pipelining */</span>
<a name="l00108"></a><a class="code" href="l__softpipe_8c.html#065f771def475aca9432d340c6eaf35b">00108</a> FILE *<a class="code" href="l__softpipe_8c.html#065f771def475aca9432d340c6eaf35b">iters_statfile</a> = NULL;
<a name="l00109"></a>00109 <span class="comment">/* file to which to print loop register pressure stats */</span>
<a name="l00110"></a><a class="code" href="l__softpipe_8c.html#9f9788ffccb227a45934435833fe651e">00110</a> FILE *<a class="code" href="l__softpipe_8c.html#9f9788ffccb227a45934435833fe651e">reg_statfile</a> = NULL;
<a name="l00111"></a>00111 <span class="comment">/* file to which to print func register pressure stats */</span>
<a name="l00112"></a><a class="code" href="l__softpipe_8c.html#66928bb443a445b2b093b1082d083379">00112</a> FILE *<a class="code" href="l__softpipe_8c.html#66928bb443a445b2b093b1082d083379">func_reg_statfile</a> = NULL;
<a name="l00113"></a>00113 <span class="comment">/* file to which to print loop spill and code size stats */</span>
<a name="l00114"></a><a class="code" href="l__softpipe_8c.html#b31a94b2b54c2bff51947401462afb8a">00114</a> FILE *<a class="code" href="l__softpipe_8c.html#b31a94b2b54c2bff51947401462afb8a">spill_statfile</a> = NULL;
<a name="l00115"></a>00115 <span class="comment">/* file to which to print function code size stats */</span>
<a name="l00116"></a><a class="code" href="l__softpipe_8c.html#05e5e553ea7e96a23f4379f954ce70bb">00116</a> FILE *<a class="code" href="l__softpipe_8c.html#05e5e553ea7e96a23f4379f954ce70bb">code_statfile</a> = NULL;
<a name="l00117"></a>00117 <span class="comment">/* file to which to print swp function code size stats */</span>
<a name="l00118"></a><a class="code" href="l__softpipe_8c.html#6124881d1ab46cfbcebdfa6852499434">00118</a> FILE *<a class="code" href="l__softpipe_8c.html#6124881d1ab46cfbcebdfa6852499434">swp_code_statfile</a> = NULL;
<a name="l00119"></a>00119 <span class="comment">/* file to which to print stats for acyclic scheduling */</span>
<a name="l00120"></a><a class="code" href="l__softpipe_8c.html#e08449fa1216f1e3436bf8d7fe73731f">00120</a> FILE *<a class="code" href="l__softpipe_8c.html#e08449fa1216f1e3436bf8d7fe73731f">acyclic_statfile</a> = NULL;
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="comment">/*************************************************************************</span>
<a name="l00123"></a>00123 <span class="comment">                Function Definitions</span>
<a name="l00124"></a>00124 <span class="comment">*************************************************************************/</span>
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 <span class="comment">/*************************************************************************</span>
<a name="l00128"></a>00128 <span class="comment">                 Interface to Code Generator</span>
<a name="l00129"></a>00129 <span class="comment">*************************************************************************/</span>
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 <span class="comment">/* Once per file initialization of memory pools and other software</span>
<a name="l00132"></a>00132 <span class="comment">   pipelining info.  Called by code generator during phase 2 initialization.</span>
<a name="l00133"></a>00133 <span class="comment">   Assumes Lsched_init has been called to perform mdes and dependence </span>
<a name="l00134"></a>00134 <span class="comment">   initialization.  The structures allocated in this function in this</span>
<a name="l00135"></a>00135 <span class="comment">   function are never freed.  They are allocated only once and then die</span>
<a name="l00136"></a>00136 <span class="comment">   when all functions in the file have been processed. */</span>
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 <span class="keywordtype">void</span>
<a name="l00139"></a><a class="code" href="l__softpipe_8h.html#0044ecaec153a71b1a018fcb06d92665">00139</a> <a class="code" href="l__softpipe_8c.html#f044c0c24784b6dda4e45d4e5688ba4d">Lpipe_init</a> (Parm_Macro_List * command_line_macro_list)
<a name="l00140"></a>00140 {
<a name="l00141"></a>00141   <span class="comment">/* initialize default code generation schema */</span>
<a name="l00142"></a>00142   <a class="code" href="l__pipe__util_8c.html#659205866ba47e73cc85c2376ecd1985">Lpipe_schema_name</a> = strdup (<span class="stringliteral">"multiple_epilogues"</span>);
<a name="l00143"></a>00143 
<a name="l00144"></a>00144   <span class="comment">/* Load the software pipelining parameters */</span>
<a name="l00145"></a>00145   L_load_parameters (L_parm_file, command_line_macro_list,
<a name="l00146"></a>00146                      <span class="stringliteral">"(Lmarkpipe"</span>, L_read_parm_lmarkpipe);
<a name="l00147"></a>00147 
<a name="l00148"></a>00148   <span class="comment">/* Renamed 'softpipe' to 'Lsoftpipe' -HCH 11/04/00 */</span>
<a name="l00149"></a>00149   L_load_parameters_aliased (L_parm_file, command_line_macro_list,
<a name="l00150"></a>00150                              <span class="stringliteral">"(Lsoftpipe"</span>, <span class="stringliteral">"(Softpipe"</span>, <a class="code" href="l__pipe__util_8c.html#6f5aa25c2a95b94ee73ac1b754207d70">L_read_parm_lpipe</a>);
<a name="l00151"></a>00151 
<a name="l00152"></a>00152   <span class="comment">/* Create memory pools for allocation of data structures */</span>
<a name="l00153"></a>00153   <a class="code" href="l__mve_8c.html#7f8629ad0a52237fabc7b5b90c9a369c">Lpipe_src_mve_pool</a> = L_create_alloc_pool (<span class="stringliteral">"src_mve_info"</span>,
<a name="l00154"></a>00154                                             L_max_src_operand *
<a name="l00155"></a>00155                                             <span class="keyword">sizeof</span> (<a class="code" href="struct__Lpipe__MVEInfo.html">Lpipe_MVEInfo</a> *), 50);
<a name="l00156"></a>00156   <a class="code" href="l__mve_8c.html#3c5eb3ef3a82d664ba3a3da10b8e0093">Lpipe_pred_mve_pool</a> =
<a name="l00157"></a>00157     L_create_alloc_pool (<span class="stringliteral">"pred_mve_info"</span>,
<a name="l00158"></a>00158                          L_max_pred_operand * <span class="keyword">sizeof</span> (Lpipe_MVEInfo *), 50);
<a name="l00159"></a>00159   <a class="code" href="l__mve_8c.html#4fd7a438ad2a7b1efa5d57d7aa1933b2">Lpipe_dest_mve_pool</a> =
<a name="l00160"></a>00160     L_create_alloc_pool (<span class="stringliteral">"dest_mve_info"</span>,
<a name="l00161"></a>00161                          L_max_dest_operand * <span class="keyword">sizeof</span> (Lpipe_MVEInfo *), 50);
<a name="l00162"></a>00162   <a class="code" href="l__mve_8c.html#47ef06dbc5fdfb506db61338bd91c45d">Lpipe_MVEInfo_pool</a> =
<a name="l00163"></a>00163     L_create_alloc_pool (<span class="stringliteral">"Lpipe_MVEInfo"</span>, <span class="keyword">sizeof</span> (Lpipe_MVEInfo), 50);
<a name="l00164"></a>00164 
<a name="l00165"></a>00165   <a class="code" href="l__softpipe__info_8c.html#bec30e2c6dd19674777250eed6a17946">Softpipe_Op_Info_pool</a> =
<a name="l00166"></a>00166     L_create_alloc_pool (<span class="stringliteral">"Softpipe_Op_Info"</span>, <span class="keyword">sizeof</span> (<a class="code" href="struct__Softpipe__Op__Info.html">Softpipe_Op_Info</a>), 50);
<a name="l00167"></a>00167 
<a name="l00168"></a>00168   <a class="code" href="l__pipe__util_8c.html#b2b35dba38efd9d6e53512e38d014729">Qnode_pool</a> = L_create_alloc_pool (<span class="stringliteral">"Qnode"</span>, <span class="keyword">sizeof</span> (<a class="code" href="structQnode.html">Qnode</a>), 50);
<a name="l00169"></a>00169   <a class="code" href="l__pipe__util_8c.html#4a9d1f680824f7426e01b910d4cc2b03">Queue_pool</a> = L_create_alloc_pool (<span class="stringliteral">"Queue"</span>, <span class="keyword">sizeof</span> (<a class="code" href="structQueue.html">Queue</a>), 3);
<a name="l00170"></a>00170 
<a name="l00171"></a>00171   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#f65026de9f77648de4df3b4f4ec74417">Lpipe_print_iteration_schedule</a> || <a class="code" href="l__pipe__util_8c.html#0b64713f1a54406156072dd81814ea25">Lpipe_print_schedules_for_debug</a>)
<a name="l00172"></a>00172     {
<a name="l00173"></a>00173       <span class="keywordtype">char</span> *sched_file_name;
<a name="l00174"></a>00174 
<a name="l00175"></a>00175       <span class="comment">/* open one .loop_sched file per input file */</span>
<a name="l00176"></a>00176       sched_file_name = (<span class="keywordtype">char</span> *) malloc (strlen (L_output_file) + 12);
<a name="l00177"></a>00177       <span class="keywordflow">if</span> (sched_file_name == NULL)
<a name="l00178"></a>00178         L_punt (<span class="stringliteral">"Lpipe_init: malloc out of space for sched_file_name\n"</span>);
<a name="l00179"></a>00179 
<a name="l00180"></a>00180       strcpy (sched_file_name, L_output_file);
<a name="l00181"></a>00181       strcat (sched_file_name, <span class="stringliteral">".loop_sched"</span>);
<a name="l00182"></a>00182       <a class="code" href="l__softpipe_8c.html#dfcefa1a772012ef80d3b8f14f3f150b">sched_file</a> = fopen (sched_file_name, <span class="stringliteral">"w"</span>);
<a name="l00183"></a>00183       <span class="keywordflow">if</span> (<a class="code" href="l__softpipe_8c.html#dfcefa1a772012ef80d3b8f14f3f150b">sched_file</a> == 0)
<a name="l00184"></a>00184         L_punt (<span class="stringliteral">"Error while processing file %s: can not open"</span>
<a name="l00185"></a>00185                 <span class="stringliteral">"file %s\n"</span>, L_input_file, sched_file_name);
<a name="l00186"></a>00186 
<a name="l00187"></a>00187       Lcode_free (sched_file_name);
<a name="l00188"></a>00188     }
<a name="l00189"></a>00189   <span class="keywordflow">else</span>
<a name="l00190"></a>00190     <a class="code" href="l__softpipe_8c.html#dfcefa1a772012ef80d3b8f14f3f150b">sched_file</a> = stdout;
<a name="l00191"></a>00191 
<a name="l00192"></a>00192   <a class="code" href="l__softpipe_8c.html#9f9788ffccb227a45934435833fe651e">reg_statfile</a> = stdout;
<a name="l00193"></a>00193   <a class="code" href="l__softpipe_8c.html#66928bb443a445b2b093b1082d083379">func_reg_statfile</a> = stdout;
<a name="l00194"></a>00194   <a class="code" href="l__softpipe_8c.html#b31a94b2b54c2bff51947401462afb8a">spill_statfile</a> = stdout;
<a name="l00195"></a>00195   <a class="code" href="l__softpipe_8c.html#05e5e553ea7e96a23f4379f954ce70bb">code_statfile</a> = stdout;
<a name="l00196"></a>00196   <a class="code" href="l__softpipe_8c.html#6124881d1ab46cfbcebdfa6852499434">swp_code_statfile</a> = stdout;
<a name="l00197"></a>00197   <a class="code" href="l__softpipe_8c.html#e08449fa1216f1e3436bf8d7fe73731f">acyclic_statfile</a> = stdout;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ab2140575cdf9b3526e6da5ea095a784">Lpipe_print_statistics</a>)
<a name="l00200"></a>00200     {
<a name="l00201"></a>00201       <a class="code" href="l__softpipe_8c.html#d4ad2d89187dec7ea2bbf365f1e10e1e">pipe_statfile</a> = fopen (<span class="stringliteral">"mark_ph2.stats"</span>, <span class="stringliteral">"a"</span>);
<a name="l00202"></a>00202       <span class="keywordflow">if</span> (<a class="code" href="l__softpipe_8c.html#d4ad2d89187dec7ea2bbf365f1e10e1e">pipe_statfile</a> == 0)
<a name="l00203"></a>00203         L_punt (<span class="stringliteral">"Error while processing file %s: cannot append to file "</span>
<a name="l00204"></a>00204                 <span class="stringliteral">"mark_ph2.stats"</span> <span class="stringliteral">"\n"</span>, L_input_file);
<a name="l00205"></a>00205       <a class="code" href="l__softpipe_8c.html#bfb992b8633f7de2f771384a01c7411e">gen_statfile</a> = fopen (<span class="stringliteral">"softpipe.stats"</span>, <span class="stringliteral">"a"</span>);
<a name="l00206"></a>00206       <span class="keywordflow">if</span> (<a class="code" href="l__softpipe_8c.html#bfb992b8633f7de2f771384a01c7411e">gen_statfile</a> == 0)
<a name="l00207"></a>00207         L_punt (<span class="stringliteral">"Error while processing file %s: cannot append to file "</span>
<a name="l00208"></a>00208                 <span class="stringliteral">"softpipe.stats"</span> <span class="stringliteral">"\n"</span>, L_input_file);
<a name="l00209"></a>00209       <a class="code" href="l__softpipe_8c.html#065f771def475aca9432d340c6eaf35b">iters_statfile</a> = fopen (<span class="stringliteral">"iters.stats"</span>, <span class="stringliteral">"a"</span>);
<a name="l00210"></a>00210       <span class="keywordflow">if</span> (<a class="code" href="l__softpipe_8c.html#065f771def475aca9432d340c6eaf35b">iters_statfile</a> == 0)
<a name="l00211"></a>00211         L_punt (<span class="stringliteral">"Error while processing file %s: cannot append to file "</span>
<a name="l00212"></a>00212                 <span class="stringliteral">"iters.stats"</span> <span class="stringliteral">"\n"</span>, L_input_file);
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214   <span class="keywordflow">else</span>
<a name="l00215"></a>00215     {
<a name="l00216"></a>00216       <a class="code" href="l__softpipe_8c.html#d4ad2d89187dec7ea2bbf365f1e10e1e">pipe_statfile</a> = stdout;
<a name="l00217"></a>00217       <a class="code" href="l__softpipe_8c.html#bfb992b8633f7de2f771384a01c7411e">gen_statfile</a> = stdout;
<a name="l00218"></a>00218       <a class="code" href="l__softpipe_8c.html#065f771def475aca9432d340c6eaf35b">iters_statfile</a> = stdout;
<a name="l00219"></a>00219     }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221   <a class="code" href="l__softpipe_8c.html#4f72a55b73cc8bb4b70700d7ba9cffe2">Lpipe_measurement_init</a> (command_line_macro_list);
<a name="l00222"></a>00222 }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 <span class="keywordtype">void</span>
<a name="l00226"></a><a class="code" href="l__softpipe_8h.html#6b73cb449fa2281895b3a4aa9d030b76">00226</a> <a class="code" href="l__softpipe_8c.html#4f72a55b73cc8bb4b70700d7ba9cffe2">Lpipe_measurement_init</a> (Parm_Macro_List * command_line_macro_list)
<a name="l00227"></a>00227 {
<a name="l00228"></a>00228   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#05b449c92ca8c59d61db6054cd56e7ee">Lpipe_compute_loop_reg_pressure</a>)
<a name="l00229"></a>00229     {
<a name="l00230"></a>00230       <a class="code" href="l__softpipe_8c.html#9f9788ffccb227a45934435833fe651e">reg_statfile</a> = fopen (<span class="stringliteral">"register.stats"</span>, <span class="stringliteral">"a"</span>);
<a name="l00231"></a>00231       <span class="keywordflow">if</span> (<a class="code" href="l__softpipe_8c.html#9f9788ffccb227a45934435833fe651e">reg_statfile</a> == 0)
<a name="l00232"></a>00232         L_punt (<span class="stringliteral">"Error while processing file %s: cannot append to file "</span>
<a name="l00233"></a>00233                 <span class="stringliteral">"register.stats"</span> <span class="stringliteral">"\n"</span>, L_input_file);
<a name="l00234"></a>00234       <a class="code" href="l__softpipe_8c.html#66928bb443a445b2b093b1082d083379">func_reg_statfile</a> = fopen (<span class="stringliteral">"func_reg.stats"</span>, <span class="stringliteral">"a"</span>);
<a name="l00235"></a>00235       <span class="keywordflow">if</span> (<a class="code" href="l__softpipe_8c.html#66928bb443a445b2b093b1082d083379">func_reg_statfile</a> == 0)
<a name="l00236"></a>00236         L_punt (<span class="stringliteral">"Error while processing file %s: cannot append to file "</span>
<a name="l00237"></a>00237                 <span class="stringliteral">"func_reg.stats"</span> <span class="stringliteral">"\n"</span>, L_input_file);
<a name="l00238"></a>00238     }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#e2d1368da174d6c3c8b7ec7d1cbbf44e">Lpipe_add_spill_attributes</a>)
<a name="l00241"></a>00241     {
<a name="l00242"></a>00242       <a class="code" href="l__softpipe_8c.html#b31a94b2b54c2bff51947401462afb8a">spill_statfile</a> = fopen (<span class="stringliteral">"spillandsize.stats"</span>, <span class="stringliteral">"a"</span>);
<a name="l00243"></a>00243       <span class="keywordflow">if</span> (<a class="code" href="l__softpipe_8c.html#b31a94b2b54c2bff51947401462afb8a">spill_statfile</a> == 0)
<a name="l00244"></a>00244         L_punt (<span class="stringliteral">"Error while processing file %s: cannot append to file "</span>
<a name="l00245"></a>00245                 <span class="stringliteral">"spillandsize.stats"</span> <span class="stringliteral">"\n"</span>, L_input_file);
<a name="l00246"></a>00246       <a class="code" href="l__softpipe_8c.html#05e5e553ea7e96a23f4379f954ce70bb">code_statfile</a> = fopen (<span class="stringliteral">"code_size.stats"</span>, <span class="stringliteral">"a"</span>);
<a name="l00247"></a>00247       <span class="keywordflow">if</span> (<a class="code" href="l__softpipe_8c.html#05e5e553ea7e96a23f4379f954ce70bb">code_statfile</a> == 0)
<a name="l00248"></a>00248         L_punt (<span class="stringliteral">"Error while processing file %s: cannot append to file "</span>
<a name="l00249"></a>00249                 <span class="stringliteral">"code_size.stats"</span> <span class="stringliteral">"\n"</span>, L_input_file);
<a name="l00250"></a>00250       <a class="code" href="l__softpipe_8c.html#6124881d1ab46cfbcebdfa6852499434">swp_code_statfile</a> = fopen (<span class="stringliteral">"swp_code_size.stats"</span>, <span class="stringliteral">"a"</span>);
<a name="l00251"></a>00251       <span class="keywordflow">if</span> (<a class="code" href="l__softpipe_8c.html#6124881d1ab46cfbcebdfa6852499434">swp_code_statfile</a> == 0)
<a name="l00252"></a>00252         L_punt (<span class="stringliteral">"Error while processing file %s: cannot append to file "</span>
<a name="l00253"></a>00253                 <span class="stringliteral">"swp_code_size.stats"</span> <span class="stringliteral">"\n"</span>, L_input_file);
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255 }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 <span class="keywordtype">void</span>
<a name="l00259"></a><a class="code" href="l__softpipe_8h.html#5f4f86dea88858861446d1e06c1dea15">00259</a> <a class="code" href="l__softpipe_8c.html#5f4f86dea88858861446d1e06c1dea15">Lpipe_cleanup</a> (<span class="keywordtype">void</span>)
<a name="l00260"></a>00260 {
<a name="l00261"></a>00261   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#f65026de9f77648de4df3b4f4ec74417">Lpipe_print_iteration_schedule</a> || <a class="code" href="l__pipe__util_8c.html#0b64713f1a54406156072dd81814ea25">Lpipe_print_schedules_for_debug</a>)
<a name="l00262"></a>00262     {
<a name="l00263"></a>00263       fclose (<a class="code" href="l__softpipe_8c.html#dfcefa1a772012ef80d3b8f14f3f150b">sched_file</a>);
<a name="l00264"></a>00264     }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ab2140575cdf9b3526e6da5ea095a784">Lpipe_print_statistics</a>)
<a name="l00267"></a>00267     {
<a name="l00268"></a>00268       fclose (<a class="code" href="l__softpipe_8c.html#d4ad2d89187dec7ea2bbf365f1e10e1e">pipe_statfile</a>);
<a name="l00269"></a>00269       fclose (<a class="code" href="l__softpipe_8c.html#bfb992b8633f7de2f771384a01c7411e">gen_statfile</a>);
<a name="l00270"></a>00270       fclose (<a class="code" href="l__softpipe_8c.html#065f771def475aca9432d340c6eaf35b">iters_statfile</a>);
<a name="l00271"></a>00271     }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273   <a class="code" href="l__softpipe_8c.html#c18c12740729ece750284668380d64dd">Lpipe_measurement_cleanup</a> ();
<a name="l00274"></a>00274 }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 <span class="keywordtype">void</span>
<a name="l00278"></a><a class="code" href="l__softpipe_8h.html#c18c12740729ece750284668380d64dd">00278</a> <a class="code" href="l__softpipe_8c.html#c18c12740729ece750284668380d64dd">Lpipe_measurement_cleanup</a> (<span class="keywordtype">void</span>)
<a name="l00279"></a>00279 {
<a name="l00280"></a>00280   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#05b449c92ca8c59d61db6054cd56e7ee">Lpipe_compute_loop_reg_pressure</a>)
<a name="l00281"></a>00281     {
<a name="l00282"></a>00282       fclose (<a class="code" href="l__softpipe_8c.html#9f9788ffccb227a45934435833fe651e">reg_statfile</a>);
<a name="l00283"></a>00283       fclose (<a class="code" href="l__softpipe_8c.html#66928bb443a445b2b093b1082d083379">func_reg_statfile</a>);
<a name="l00284"></a>00284     }
<a name="l00285"></a>00285   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#e2d1368da174d6c3c8b7ec7d1cbbf44e">Lpipe_add_spill_attributes</a>)
<a name="l00286"></a>00286     {
<a name="l00287"></a>00287       fclose (<a class="code" href="l__softpipe_8c.html#b31a94b2b54c2bff51947401462afb8a">spill_statfile</a>);
<a name="l00288"></a>00288       fclose (<a class="code" href="l__softpipe_8c.html#05e5e553ea7e96a23f4379f954ce70bb">code_statfile</a>);
<a name="l00289"></a>00289       fclose (<a class="code" href="l__softpipe_8c.html#6124881d1ab46cfbcebdfa6852499434">swp_code_statfile</a>);
<a name="l00290"></a>00290     }
<a name="l00291"></a>00291 }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00295"></a><a class="code" href="l__softpipe_8c.html#dc1a6d6920170c96e1c6d6d52eacf808">00295</a> <a class="code" href="l__softpipe_8c.html#dc1a6d6920170c96e1c6d6d52eacf808">Lpipe_failure</a> (<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Cb.html">SM_Cb</a> *sm_cb, Softpipe_MinII *MinII)
<a name="l00296"></a>00296 {
<a name="l00297"></a>00297   L_Attr *attr;
<a name="l00298"></a>00298   L_Cb *cb = sm_cb-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Cb.html#b69cef60244b3cc923619329b3f8e622">lcode_cb</a>;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300   <span class="comment">/* If softpipe failed, then mark the II as -1 as an indicator. */</span>
<a name="l00301"></a>00301   attr = L_new_attr (<span class="stringliteral">"II"</span>, 1);
<a name="l00302"></a>00302   L_set_int_attr_field (attr, 0, -1);
<a name="l00303"></a>00303   cb-&gt;attr = L_concat_attr (cb-&gt;attr, attr);
<a name="l00304"></a>00304 
<a name="l00305"></a>00305   <span class="comment">/* Clear the kernel flag and remove the SOFTPIPE flag</span>
<a name="l00306"></a>00306 <span class="comment">     from the kernel so it can be acyclic scheduled. */</span>
<a name="l00307"></a>00307   <span class="keywordflow">if</span> ((attr = L_find_attr (cb-&gt;attr, <span class="stringliteral">"kernel"</span>)))
<a name="l00308"></a>00308     cb-&gt;attr = L_delete_attr (cb-&gt;attr, attr);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310   <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;flags = L_CLR_BIT_FLAG (cb-&gt;flags, L_CB_SOFTPIPE);
<a name="l00311"></a>00311 
<a name="l00312"></a>00312   <a class="code" href="l__pipe__util_8c.html#e21d164bb9d5070bbf1f2250d5d27501">Lpipe_delete_start_stop_nodes</a> (sm_cb);
<a name="l00313"></a>00313 
<a name="l00314"></a>00314   <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/sm_8c.html#48459436e1be4f10529483a6c5f6770c">SM_delete_cb</a> (sm_cb);
<a name="l00315"></a>00315       
<a name="l00316"></a>00316   Lcode_free (MinII);
<a name="l00317"></a>00317   <a class="code" href="l__softpipe__info_8c.html#62ce42282a593806d185df143094a321">Lpipe_free_op_info</a> (cb);
<a name="l00318"></a>00318 
<a name="l00319"></a>00319   <span class="keywordflow">return</span>;
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="l__softpipe_8c.html#950faa312298324e1d5634c3c4842ae1">Lpipe_compute_start_stop_issue_time</a> (<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Cb.html">SM_Cb</a> * sm_cb);
<a name="l00323"></a>00323 
<a name="l00324"></a>00324 <span class="comment">/* make sure start operation is scheduled as late as possible and stop</span>
<a name="l00325"></a>00325 <span class="comment">   operation is scheduled as early as possible */</span>
<a name="l00326"></a>00326 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00327"></a><a class="code" href="l__softpipe_8c.html#950faa312298324e1d5634c3c4842ae1">00327</a> <a class="code" href="l__softpipe_8c.html#950faa312298324e1d5634c3c4842ae1">Lpipe_compute_start_stop_issue_time</a> (<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Cb.html">SM_Cb</a> * sm_cb)
<a name="l00328"></a>00328 {
<a name="l00329"></a>00329   <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Oper.html">SM_Oper</a> *sm_op;
<a name="l00330"></a>00330   <a class="code" href="struct__Softpipe__Op__Info.html">Softpipe_Op_Info</a> *softpipe_info;
<a name="l00331"></a>00331   <span class="keywordtype">int</span> earliest_real_issue_time; <span class="comment">/* issue time of the earliest oper</span>
<a name="l00332"></a>00332 <span class="comment">                                   which is not the start oper */</span>
<a name="l00333"></a>00333   <span class="keywordtype">int</span> latest_real_issue_time;   <span class="comment">/* issue time of the latest oper</span>
<a name="l00334"></a>00334 <span class="comment">                                   which is not the stop oper */</span>
<a name="l00335"></a>00335 
<a name="l00336"></a>00336   earliest_real_issue_time = <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/sm_8h.html#e84ecd39117474b57748ff3565e7aa5c">SM_MAX_CYCLE</a>;
<a name="l00337"></a>00337   latest_real_issue_time = <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/sm_8h.html#a876cebdda63a2bce1e558a87cae65c3">SM_MIN_CYCLE</a>;
<a name="l00338"></a>00338 
<a name="l00339"></a>00339   <span class="comment">/* find earliest issue time and latest issue time among all opers</span>
<a name="l00340"></a>00340 <span class="comment">     exlcuding the start and stop nodes */</span>
<a name="l00341"></a>00341   <span class="keywordflow">for</span> (sm_op = sm_cb-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Cb.html#a89868f9a5bb0dabe28a9c74d44a6286">first_serial_op</a>; sm_op;
<a name="l00342"></a>00342        sm_op = sm_op-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Oper.html#c7c35fc98ddf3d343118f16a6bfd0f99">next_serial_op</a>)
<a name="l00343"></a>00343     {
<a name="l00344"></a>00344       softpipe_info = <a class="code" href="l__softpipe__int_8h.html#50a06a5d593647c987ffc62034b61991">SOFTPIPE_OP_INFO</a> (sm_op-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Oper.html#3f5397d6d9a8bf4c7d31e4dd0219f6a9">lcode_op</a>);
<a name="l00345"></a>00345       <span class="keywordflow">if</span> (L_START_STOP_NODE (sm_op-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Oper.html#3f5397d6d9a8bf4c7d31e4dd0219f6a9">lcode_op</a>))
<a name="l00346"></a>00346         <span class="keywordflow">continue</span>;
<a name="l00347"></a>00347       <span class="keywordflow">if</span> (sm_op-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Oper.html#9adb1e3b27a12ac7ae0ed7ad7002dce2">sched_cycle</a> &lt; earliest_real_issue_time)
<a name="l00348"></a>00348         earliest_real_issue_time = sm_op-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Oper.html#9adb1e3b27a12ac7ae0ed7ad7002dce2">sched_cycle</a>;
<a name="l00349"></a>00349       <span class="keywordflow">if</span> (sm_op-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Oper.html#9adb1e3b27a12ac7ae0ed7ad7002dce2">sched_cycle</a> &gt; latest_real_issue_time)
<a name="l00350"></a>00350         latest_real_issue_time = sm_op-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Oper.html#9adb1e3b27a12ac7ae0ed7ad7002dce2">sched_cycle</a>;
<a name="l00351"></a>00351     }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353   <span class="comment">/* issue time of the start oper should be the earliest_real_issue_time */</span>
<a name="l00354"></a>00354   softpipe_info = <a class="code" href="l__softpipe__int_8h.html#50a06a5d593647c987ffc62034b61991">SOFTPIPE_OP_INFO</a> (sm_cb-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Cb.html#a89868f9a5bb0dabe28a9c74d44a6286">first_serial_op</a>-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Oper.html#3f5397d6d9a8bf4c7d31e4dd0219f6a9">lcode_op</a>);
<a name="l00355"></a>00355   softpipe_info-&gt;<a class="code" href="struct__Softpipe__Op__Info.html#7d7e64bcab97f4fccde857ee7430b6ec">intra_iter_issue_time</a> = earliest_real_issue_time;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357   <span class="comment">/* issue time of the stop oper should be the latest_real_issue_time */</span>
<a name="l00358"></a>00358   softpipe_info = <a class="code" href="l__softpipe__int_8h.html#50a06a5d593647c987ffc62034b61991">SOFTPIPE_OP_INFO</a> (sm_cb-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Cb.html#72a08b1707e79a4ac78ad8ee2e1a2574">last_serial_op</a>-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Oper.html#3f5397d6d9a8bf4c7d31e4dd0219f6a9">lcode_op</a>);
<a name="l00359"></a>00359   softpipe_info-&gt;<a class="code" href="struct__Softpipe__Op__Info.html#7d7e64bcab97f4fccde857ee7430b6ec">intra_iter_issue_time</a> = latest_real_issue_time;
<a name="l00360"></a>00360   <span class="keywordflow">return</span>;
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 <span class="comment">/* Requires oper wt */</span>
<a name="l00365"></a>00365 
<a name="l00366"></a>00366 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00367"></a><a class="code" href="l__softpipe_8c.html#cd9bb1e732e6b1dd2cb4071650da8534">00367</a> <a class="code" href="l__softpipe_8c.html#cd9bb1e732e6b1dd2cb4071650da8534">Lpipe_pipeline_loop</a> (L_Func *fn, L_Inner_Loop *loop)
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369   L_Oper *loop_incr, *loop_back_br, *oper, *last_oper;
<a name="l00370"></a>00370   <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Cb.html">SM_Cb</a> *sm_cb;
<a name="l00371"></a>00371   <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Oper.html">SM_Oper</a> *sm_loop_incr, *sm_loop_back_br;
<a name="l00372"></a>00372   L_Attr *attr;
<a name="l00373"></a>00373   <span class="keywordtype">int</span> num_oper, branch_count, ii, unroll, budget, tries, success;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375   Softpipe_MinII *MinII;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377   <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a> = loop-&gt;cb;
<a name="l00378"></a>00378 
<a name="l00379"></a>00379   <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;flags = L_SET_BIT_FLAG (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;flags, L_CB_SOFTPIPE);
<a name="l00380"></a>00380 
<a name="l00381"></a>00381   <span class="comment">/* find loop back branch */</span>
<a name="l00382"></a>00382   loop_back_br = loop-&gt;feedback_op;
<a name="l00383"></a>00383 
<a name="l00384"></a>00384   <span class="keywordflow">if</span> (L_uncond_branch_opcode (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;last_op) &amp;&amp;
<a name="l00385"></a>00385       L_is_predicated (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;last_op) &amp;&amp;
<a name="l00386"></a>00386       L_EXTRACT_BIT_VAL (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;flags, L_CB_HYPERBLOCK_NO_FALLTHRU))
<a name="l00387"></a>00387     {
<a name="l00388"></a>00388       L_warn (<span class="stringliteral">"Promoting uncond br of nofallthru pipelined loop (cb %d)"</span>,
<a name="l00389"></a>00389               <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;id);
<a name="l00390"></a>00390       L_delete_operand (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;last_op-&gt;pred[0]);
<a name="l00391"></a>00391       <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;last_op-&gt;pred[0] = NULL;
<a name="l00392"></a>00392     }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ab2140575cdf9b3526e6da5ea095a784">Lpipe_print_statistics</a>)
<a name="l00395"></a>00395     {
<a name="l00396"></a>00396       fprintf (<a class="code" href="l__softpipe_8c.html#d4ad2d89187dec7ea2bbf365f1e10e1e">pipe_statfile</a>, <span class="stringliteral">":) Loop with header cb %d still OK "</span>
<a name="l00397"></a>00397                <span class="stringliteral">"for software pipelining\n"</span>, <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;id);
<a name="l00398"></a>00398       fprintf (<a class="code" href="l__softpipe_8c.html#bfb992b8633f7de2f771384a01c7411e">gen_statfile</a>, <span class="stringliteral">"\n"</span>);
<a name="l00399"></a>00399       <span class="comment">/* print source line number for loop if available and print cb id */</span>
<a name="l00400"></a>00400       <span class="keywordflow">if</span> ((attr = L_find_attr (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr, <span class="stringliteral">"LOOP"</span>)))
<a name="l00401"></a>00401         fprintf (<a class="code" href="l__softpipe_8c.html#bfb992b8633f7de2f771384a01c7411e">gen_statfile</a>,
<a name="l00402"></a>00402                  <span class="stringliteral">"Pipelining statistics for loop on line: "</span> ITintmaxformat
<a name="l00403"></a>00403                  <span class="stringliteral">"\n"</span>, attr-&gt;field[1]-&gt;value.i);
<a name="l00404"></a>00404       <span class="keywordflow">else</span>
<a name="l00405"></a>00405         fprintf (<a class="code" href="l__softpipe_8c.html#bfb992b8633f7de2f771384a01c7411e">gen_statfile</a>,
<a name="l00406"></a>00406                  <span class="stringliteral">"Pipelining_statistics for loop:\n"</span>);
<a name="l00407"></a>00407       fprintf (<a class="code" href="l__softpipe_8c.html#bfb992b8633f7de2f771384a01c7411e">gen_statfile</a>, <span class="stringliteral">"Cb: %d\n"</span>, <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;id);
<a name="l00408"></a>00408       fprintf (<a class="code" href="l__softpipe_8c.html#bfb992b8633f7de2f771384a01c7411e">gen_statfile</a>, <span class="stringliteral">"Function: %s\n"</span>, fn-&gt;name);
<a name="l00409"></a>00409       fprintf (<a class="code" href="l__softpipe_8c.html#bfb992b8633f7de2f771384a01c7411e">gen_statfile</a>, <span class="stringliteral">"Average_iterations: %f\n"</span>,
<a name="l00410"></a>00410                loop-&gt;ave_iteration);
<a name="l00411"></a>00411     }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413   <span class="comment">/* Find preheader */</span>
<a name="l00414"></a>00414   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#9929661b757af9845e6325f4752a7d87">Lpipe_schema</a> == <a class="code" href="l__pipe__util_8h.html#3225a520483e53a39cab55104dcd0e5a">REM_LOOP</a>)
<a name="l00415"></a>00415     {
<a name="l00416"></a>00416       L_punt (<span class="stringliteral">"Lpipe_pipeline_loop: Remainder loops unsupported"</span>);
<a name="l00417"></a>00417       <span class="comment">/* for remainder loop, prologue cb was inserted between the</span>
<a name="l00418"></a>00418 <span class="comment">         preheader and the header during loop prep */</span>
<a name="l00419"></a>00419       <a class="code" href="l__softpipe_8c.html#4ee6d00e67672cc9a04b6f5f533bfb72">preheader_cb</a> = <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;prev_cb-&gt;prev_cb;
<a name="l00420"></a>00420     }
<a name="l00421"></a>00421   <span class="keywordflow">else</span>
<a name="l00422"></a>00422     {
<a name="l00423"></a>00423       <a class="code" href="l__softpipe_8c.html#4ee6d00e67672cc9a04b6f5f533bfb72">preheader_cb</a> = loop-&gt;preheader;
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426   <span class="comment">/* initialize prologue and remainder cb */</span>
<a name="l00427"></a>00427   <a class="code" href="l__softpipe_8c.html#4708e528902bf49b9c374df3e644309d">prologue_cb</a> = 0;
<a name="l00428"></a>00428   <a class="code" href="l__softpipe_8c.html#785a1b69c62478bf5624354abd3955e1">remainder_cb</a> = 0;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430   <span class="comment">/* print source line number and/or cb id for loop */</span>
<a name="l00431"></a>00431   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ad83dd0fea79c90886829873235d97be">Lpipe_debug</a> &gt;= 1)
<a name="l00432"></a>00432     {
<a name="l00433"></a>00433       attr = L_find_attr (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr, <span class="stringliteral">"LOOP"</span>);
<a name="l00434"></a>00434       <span class="keywordflow">if</span> ((attr != NULL) &amp;&amp;
<a name="l00435"></a>00435           (!strcmp (attr-&gt;field[0]-&gt;value.s, <span class="stringliteral">"\"dosuper\""</span>) ||
<a name="l00436"></a>00436            !strcmp (attr-&gt;field[0]-&gt;value.s, <span class="stringliteral">"\"doserial\""</span>) ||
<a name="l00437"></a>00437            !strcmp (attr-&gt;field[0]-&gt;value.s, <span class="stringliteral">"\"while\""</span>) ||
<a name="l00438"></a>00438            !strcmp (attr-&gt;field[0]-&gt;value.s, <span class="stringliteral">"\"for\""</span>) ||
<a name="l00439"></a>00439            !strcmp (attr-&gt;field[0]-&gt;value.s, <span class="stringliteral">"\"do\""</span>)))
<a name="l00440"></a>00440         {
<a name="l00441"></a>00441           fprintf (stderr,
<a name="l00442"></a>00442                    <span class="stringliteral">"Pipelining loop (function %s, line "</span> ITintmaxformat
<a name="l00443"></a>00443                    <span class="stringliteral">", cb %d)\n"</span>, fn-&gt;name, attr-&gt;field[1]-&gt;value.i,
<a name="l00444"></a>00444                    <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;id);
<a name="l00445"></a>00445         }
<a name="l00446"></a>00446       <span class="keywordflow">else</span>
<a name="l00447"></a>00447         {
<a name="l00448"></a>00448           fprintf (stderr, <span class="stringliteral">"Pipelining loop (function %s, cb %d)\n"</span>,
<a name="l00449"></a>00449                    fn-&gt;name, <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;id);
<a name="l00450"></a>00450         }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452       <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ad83dd0fea79c90886829873235d97be">Lpipe_debug</a> &gt;= 2)
<a name="l00453"></a>00453         L_print_cb (stdout, fn, <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>);
<a name="l00454"></a>00454     }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ab2140575cdf9b3526e6da5ea095a784">Lpipe_print_statistics</a>)
<a name="l00457"></a>00457     {
<a name="l00458"></a>00458       fprintf (<a class="code" href="l__softpipe_8c.html#065f771def475aca9432d340c6eaf35b">iters_statfile</a>, <span class="stringliteral">"\n"</span>);
<a name="l00459"></a>00459       attr = L_find_attr (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr, <span class="stringliteral">"LOOP"</span>);
<a name="l00460"></a>00460       <span class="comment">/* print source line number for loop if available and print cb id */</span>
<a name="l00461"></a>00461 
<a name="l00462"></a>00462       fprintf (iters_statfile,
<a name="l00463"></a>00463                <span class="stringliteral">"Pipelining_statistics_for_loop_on_line: "</span> ITintmaxformat
<a name="l00464"></a>00464                <span class="stringliteral">"\n"</span>, attr ? attr-&gt;field[1]-&gt;value.i : 0);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466       fprintf (iters_statfile, <span class="stringliteral">"Cb: %d\n"</span>, <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;id);
<a name="l00467"></a>00467       fprintf (iters_statfile, <span class="stringliteral">"Function: %s\n"</span>, fn-&gt;name);
<a name="l00468"></a>00468       fprintf (iters_statfile, <span class="stringliteral">"Average_iterations: %f\n"</span>,
<a name="l00469"></a>00469                loop-&gt;ave_iteration);
<a name="l00470"></a>00470     }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472   <span class="comment">/* Construct the SM CB for MRT.  Anti- and output dependences are</span>
<a name="l00473"></a>00473 <span class="comment">   * constructed by SM, but ignored assuming that a subsequent run</span>
<a name="l00474"></a>00474 <span class="comment">   * of MVE will alleviate any broken dependences.</span>
<a name="l00475"></a>00475 <span class="comment">   */</span>
<a name="l00476"></a>00476 
<a name="l00477"></a>00477   sm_cb = <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/sm_8c.html#a3abf3f985c8090e785d3ed290c9c7d4">SM_new_cb</a> (<a class="codeRef" doxygen="liblmdes.tag:../../../../machine/Lmdes/html/" href="../../../../machine/Lmdes/html/lmdes_8c.html#fccb3150d93023d97c16ad96e4db32dd">lmdes</a>, <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>,
<a name="l00478"></a>00478                      <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/sm_8h.html#b6f5a8525404290f28629d80ac61a0a8">SM_PREPASS</a> | <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/sm_8h.html#50988797370cea1fa3b8446bb99201b9">SM_MODULO</a> | <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/sm_8h.html#5e5919e0b9090b92f54d9af0f05d5787">SM_NORMALIZE_ISSUE</a>);
<a name="l00479"></a>00479 
<a name="l00480"></a>00480   <span class="comment">/* Find induction op for iteration variable */</span>
<a name="l00481"></a>00481   loop_incr = L_find_inner_loop_counter (loop);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483   <span class="comment">/* Set up SM structures */</span>
<a name="l00484"></a>00484   sm_loop_back_br = <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/sm_8c.html#8a87e702f9b4517fc0791d11d8a20438">SM_find_sm_op</a> (sm_cb, loop_back_br);
<a name="l00485"></a>00485 
<a name="l00486"></a>00486   <span class="comment">/* 20030107 SZU</span>
<a name="l00487"></a>00487 <span class="comment">   * Add to SM_Oper-&gt;flags that this is loop_back_br.</span>
<a name="l00488"></a>00488 <span class="comment">   * Was for bundling algorithm only; shouldn't cause problem.</span>
<a name="l00489"></a>00489 <span class="comment">   */</span>
<a name="l00490"></a>00490   sm_loop_back_br-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Oper.html#b938730250455390f086f1e0894307cb">flags</a> |= <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/sm_8h.html#6ea6f14fb0429c44def7c161244fe4d3">SM_LOOP_BACK_BR</a>;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492   sm_loop_incr = <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/sm_8c.html#8a87e702f9b4517fc0791d11d8a20438">SM_find_sm_op</a> (sm_cb, loop_incr);
<a name="l00493"></a>00493   <span class="comment">/* MCM There is also a num_slots that could also be used. */</span>
<a name="l00494"></a>00494   <a class="code" href="l__softpipe_8c.html#377860f550eb8f35543d1b7c4a931268">Lpipe_total_issue_slots</a> = sm_cb-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Cb.html#afb5a7e1da77923aa1463e8a3d819cf1">version1_mdes</a>-&gt;<a class="codeRef" doxygen="liblmdes.tag:../../../../machine/Lmdes/html/" href="../../../../machine/Lmdes/html/structmdes__st.html#765cd60f19962a53e13c5cec60caeb34">max_slot</a> + 1;
<a name="l00495"></a>00495 
<a name="l00496"></a>00496   <a class="code" href="l__softpipe__info_8c.html#8d0bf852772189f5c84753f7efa2f4e4">Lpipe_construct_op_info</a> (sm_cb, sm_loop_back_br,
<a name="l00497"></a>00497                            &amp;num_oper, &amp;branch_count);
<a name="l00498"></a>00498 
<a name="l00499"></a>00499   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ad83dd0fea79c90886829873235d97be">Lpipe_debug</a> &gt;= 1)
<a name="l00500"></a>00500     <a class="code" href="l__softpipe__info_8c.html#a5f0f3fb74601d90b6f5de3b32a39a7a">Lpipe_print_cb_info</a> (sm_cb);
<a name="l00501"></a>00501 
<a name="l00502"></a>00502   <a class="code" href="l__pipe__util_8c.html#4d45e5623b3ff132a813e2a9adf69150">Lpipe_create_start_stop_nodes</a> (sm_cb);
<a name="l00503"></a>00503   <a class="code" href="l__pipe__sched_8c.html#1f114627d53f0fcfd8f9b0b943d8750f">Lpipe_mark_branch_path_opers</a> (sm_cb, sm_loop_back_br);
<a name="l00504"></a>00504 
<a name="l00505"></a>00505   MinII = Lpipe_determine_mii (sm_cb, <a class="code" href="l__pipe__util_8c.html#971e2f43a9bcf87d02ca3adb1f632358">Lpipe_max_ii</a>);
<a name="l00506"></a>00506   ii = MinII-&gt;MinII;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508   attr = L_new_attr (<span class="stringliteral">"softpipe_MinII_res_rec"</span>, 2);
<a name="l00509"></a>00509   L_set_int_attr_field (attr, 0, MinII-&gt;res_MinII);
<a name="l00510"></a>00510   L_set_int_attr_field (attr, 1, MinII-&gt;rec_MinII);
<a name="l00511"></a>00511   <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr = L_concat_attr (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr, attr);
<a name="l00512"></a>00512 
<a name="l00513"></a>00513   <span class="keywordflow">if</span> (MinII-&gt;MinII == -1)
<a name="l00514"></a>00514     {
<a name="l00515"></a>00515       L_warn (<span class="stringliteral">"Lpipe_pipeline_loop: "</span>
<a name="l00516"></a>00516               <span class="stringliteral">"MinII &gt; MAX_MinII %d, giving up."</span>, <a class="code" href="l__pipe__util_8c.html#971e2f43a9bcf87d02ca3adb1f632358">Lpipe_max_ii</a>);
<a name="l00517"></a>00517       <a class="code" href="l__softpipe_8c.html#dc1a6d6920170c96e1c6d6d52eacf808">Lpipe_failure</a> (sm_cb, MinII);
<a name="l00518"></a>00518       <span class="keywordflow">return</span> 1;
<a name="l00519"></a>00519     }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ad83dd0fea79c90886829873235d97be">Lpipe_debug</a> &gt;= 1)
<a name="l00522"></a>00522     printf (<span class="stringliteral">"Pipelining loop with res_MinII = %d, rec_MinII = %d, "</span>
<a name="l00523"></a>00523             <span class="stringliteral">"eff_MinII = %f (function %s, cb %d)\n"</span>,
<a name="l00524"></a>00524             MinII-&gt;res_MinII, MinII-&gt;rec_MinII, MinII-&gt;eff_MinII,
<a name="l00525"></a>00525             sm_cb-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Cb.html#19508ea8764d62f6c2c2b66ebed33204">lcode_fn</a>-&gt;name, sm_cb-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Cb.html#b69cef60244b3cc923619329b3f8e622">lcode_cb</a>-&gt;id);
<a name="l00526"></a>00526 
<a name="l00527"></a>00527   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#05fca7cb5ae9510942db3f6c0307a355">Lpipe_min_ii</a> &amp;&amp; <a class="code" href="l__pipe__util_8c.html#05fca7cb5ae9510942db3f6c0307a355">Lpipe_min_ii</a> &gt; ii)
<a name="l00528"></a>00528     {
<a name="l00529"></a>00529       ii = <a class="code" href="l__pipe__util_8c.html#05fca7cb5ae9510942db3f6c0307a355">Lpipe_min_ii</a>;
<a name="l00530"></a>00530       L_warn (<span class="stringliteral">"Lpipe_pipeline_loop: "</span>
<a name="l00531"></a>00531               <span class="stringliteral">"Limiting to Lpipe_min_ii of %d\n"</span>, ii);
<a name="l00532"></a>00532     }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534   budget = (int) (<a class="code" href="l__pipe__util_8c.html#a50c2551f678955eabc6e79793268ffa">Lpipe_budget_ratio</a> * (<span class="keywordtype">float</span>) (sm_cb-&gt;<a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/structSM__Cb.html#84b62387724ee1dd859bdc3312269c78">op_count</a> - 2));
<a name="l00535"></a>00535 
<a name="l00536"></a>00536   <span class="comment">/* Neutralize the self-dependences for scheduling purposes. </span>
<a name="l00537"></a>00537 <span class="comment">     These deps are needed for ii calculation. */</span>
<a name="l00538"></a>00538   <a class="code" href="l__pipe__util_8c.html#fe0fa3d6120b61b121fc43231a6d890d">Lpipe_ignore_self_dependences</a> (sm_cb);
<a name="l00539"></a>00539 
<a name="l00540"></a>00540   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ad83dd0fea79c90886829873235d97be">Lpipe_debug</a> &gt;= 2)
<a name="l00541"></a>00541     <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/sm_8h.html#3146d8578acda2cab53688b0ed0354dc">SM_print_cb_dependences</a> (stdout, sm_cb);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543   <span class="comment">/* Attempt to schedule at candidate IIs until successful, or until</span>
<a name="l00544"></a>00544 <span class="comment">     II is too large or too many candidate IIs have been tried. */</span>
<a name="l00545"></a>00545   tries = 1;
<a name="l00546"></a>00546 
<a name="l00547"></a>00547   <span class="keywordflow">while</span> (!(success = <a class="code" href="l__pipe__sched_8c.html#01e3114cfbc096dc1fce4b7ee4039a61">Lpipe_sm_schedule</a> (sm_cb, ii, sm_loop_back_br, budget)))
<a name="l00548"></a>00548     {
<a name="l00549"></a>00549       <span class="keywordflow">if</span> (tries &gt;= <a class="code" href="l__softpipe_8c.html#fd63d23830ad86d01b6fff2e6c615f7e">MAX_TRIES</a>)
<a name="l00550"></a>00550         {
<a name="l00551"></a>00551           L_warn (<span class="stringliteral">"Lpipe_pipeline_loop: "</span>
<a name="l00552"></a>00552                   <span class="stringliteral">"too many tries (%d) on this loop, giving up."</span>, <a class="code" href="l__softpipe_8c.html#fd63d23830ad86d01b6fff2e6c615f7e">MAX_TRIES</a>);
<a name="l00553"></a>00553           <span class="keywordflow">break</span>;
<a name="l00554"></a>00554         }
<a name="l00555"></a>00555       <span class="keywordflow">if</span> (ii &gt;= <a class="code" href="l__pipe__util_8c.html#971e2f43a9bcf87d02ca3adb1f632358">Lpipe_max_ii</a>)
<a name="l00556"></a>00556         {
<a name="l00557"></a>00557           L_warn (<span class="stringliteral">"Lpipe_pipeline_loop: "</span>
<a name="l00558"></a>00558                   <span class="stringliteral">"II &gt; %d, giving up."</span>, <a class="code" href="l__pipe__util_8c.html#971e2f43a9bcf87d02ca3adb1f632358">Lpipe_max_ii</a>);
<a name="l00559"></a>00559           <span class="keywordflow">break</span>;
<a name="l00560"></a>00560         }
<a name="l00561"></a>00561 
<a name="l00562"></a>00562       ii++;
<a name="l00563"></a>00563       tries++;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565       <span class="comment">/* Need to recompute MinDist for the new candidate II.  RecMinII is </span>
<a name="l00566"></a>00566 <span class="comment">         not changing, only the achieved II. */</span>
<a name="l00567"></a>00567       <span class="keywordflow">if</span> (Lpipe_build_MinDist (sm_cb, ii))
<a name="l00568"></a>00568         L_punt (<span class="stringliteral">"Failed recalculating MinDist"</span>);
<a name="l00569"></a>00569     }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571   <span class="keywordflow">if</span> (!success)
<a name="l00572"></a>00572     {
<a name="l00573"></a>00573       <span class="comment">/* Unable to schedule within constraints --- punting */</span>
<a name="l00574"></a>00574       <a class="code" href="l__softpipe_8c.html#dc1a6d6920170c96e1c6d6d52eacf808">Lpipe_failure</a> (sm_cb, MinII);
<a name="l00575"></a>00575       <span class="keywordflow">return</span> 1;
<a name="l00576"></a>00576     }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578   <span class="comment">/* CB Scheduled within constraints! */</span>
<a name="l00579"></a>00579   
<a name="l00580"></a>00580   <a class="code" href="l__softpipe_8c.html#950faa312298324e1d5634c3c4842ae1">Lpipe_compute_start_stop_issue_time</a> (sm_cb);
<a name="l00581"></a>00581   <a class="code" href="l__pipe__util_8c.html#e21d164bb9d5070bbf1f2250d5d27501">Lpipe_delete_start_stop_nodes</a> (sm_cb);
<a name="l00582"></a>00582 
<a name="l00583"></a>00583   <a class="code" href="l__softpipe_8c.html#e9b3310fa8a82cd6903c833cef98effd">Lpipe_stage_count</a> = sm_cb-&gt;stages;
<a name="l00584"></a>00584 
<a name="l00585"></a>00585   <a class="code" href="l__pipe__sched_8c.html#9d49fd9203ffb941ebcc7e0d5dca5140">Lpipe_sm_commit</a> (sm_cb);
<a name="l00586"></a>00586 
<a name="l00587"></a>00587   <span class="comment">/* MODULO VARIABLE RECTIFICATION */</span>
<a name="l00588"></a>00588 
<a name="l00589"></a>00589   <span class="comment">/* the number of speculatively executed stages is equal to the stage</span>
<a name="l00590"></a>00590 <span class="comment">     number in which the loop back branch is scheduled */</span>
<a name="l00591"></a>00591 
<a name="l00592"></a>00592   <span class="keywordflow">if</span> ((unroll = <a class="code" href="l__mve_8c.html#66180998b7a313e243cc0cef7058723e">Lpipe_analyze_lr</a> (sm_cb, 0)) == -1)
<a name="l00593"></a>00593     {
<a name="l00594"></a>00594       <a class="code" href="l__pipe__sched_8c.html#dee91af7d1d223f216f3c892e3ec9c0f">Lpipe_sm_terminate</a> (sm_cb);
<a name="l00595"></a>00595       <a class="code" href="l__softpipe_8c.html#dc1a6d6920170c96e1c6d6d52eacf808">Lpipe_failure</a> (sm_cb, MinII);
<a name="l00596"></a>00596       <span class="keywordflow">return</span> 1;
<a name="l00597"></a>00597     }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ad83dd0fea79c90886829873235d97be">Lpipe_debug</a> &gt;= 2)
<a name="l00600"></a>00600     <a class="code" href="l__pipe__util_8c.html#b586f12896d4906e0e7015d4ea36b61e">Lpipe_print_cb_schedule</a> (stdout, fn, sm_cb);
<a name="l00601"></a>00601 
<a name="l00602"></a>00602   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ab2140575cdf9b3526e6da5ea095a784">Lpipe_print_statistics</a>)
<a name="l00603"></a>00603     {
<a name="l00604"></a>00604       <a class="code" href="struct__Softpipe__Op__Info.html">Softpipe_Op_Info</a> *softpipe_info = <a class="code" href="l__softpipe__int_8h.html#50a06a5d593647c987ffc62034b61991">SOFTPIPE_OP_INFO</a> (loop_back_br);
<a name="l00605"></a>00605       <span class="keywordtype">int</span> theta = softpipe_info-&gt;<a class="code" href="struct__Softpipe__Op__Info.html#1c69466278e98d42ca7bd8d91916cd93">stage</a>;
<a name="l00606"></a>00606       <span class="keywordtype">int</span> schedule_length = sm_cb-&gt;last_sched_op-&gt;sched_cycle -
<a name="l00607"></a>00607         sm_cb-&gt;first_sched_op-&gt;sched_cycle + 1;
<a name="l00608"></a>00608 
<a name="l00609"></a>00609       <a class="code" href="l__pipe__util_8c.html#1717d05a7fa2b065c482d5476745d580">Lpipe_print_cyclic_stats</a> (<a class="code" href="l__softpipe_8c.html#bfb992b8633f7de2f771384a01c7411e">gen_statfile</a>, <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>,
<a name="l00610"></a>00610                                 MinII, ii, tries, schedule_length,
<a name="l00611"></a>00611                                 <a class="code" href="l__softpipe_8c.html#4dc68702d9b52f9ccb3dc704c3382dad">loop_dep_height</a>, <a class="code" href="l__softpipe_8c.html#e9b3310fa8a82cd6903c833cef98effd">Lpipe_stage_count</a>,
<a name="l00612"></a>00612                                 unroll, theta, num_oper, branch_count,
<a name="l00613"></a>00613                                 loop);
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615 
<a name="l00616"></a>00616   <span class="comment">/* From this point until the epilogues are generated and live out values</span>
<a name="l00617"></a>00617 <span class="comment">     and branches are fixed up, the Lcode is in an inconsistent state. </span>
<a name="l00618"></a>00618 <span class="comment">     If printed during this time, it is almost surely not runnable</span>
<a name="l00619"></a>00619 <span class="comment">     or even compileable by other modules.  </span>
<a name="l00620"></a>00620 <span class="comment">     There is enough information in the Softpipe_Op_Info and MVE </span>
<a name="l00621"></a>00621 <span class="comment">     data structures to now construct the software pipeline from the </span>
<a name="l00622"></a>00622 <span class="comment">     original loop body. */</span>
<a name="l00623"></a>00623 
<a name="l00624"></a>00624   <span class="comment">/* adjust sync arcs for modulo scheduled loop body */</span>
<a name="l00625"></a>00625   <a class="code" href="l__pipe__sync_8c.html#0bef7d95bb30bcb052fb9d8064a32d58">Lpipe_adjust_syncs_for_modulo_sched</a> (sm_cb);
<a name="l00626"></a>00626   
<a name="l00627"></a>00627   <span class="comment">/* If stage count is greater than 1, intra iteration memory </span>
<a name="l00628"></a>00628 <span class="comment">     dependences in the original loop can become cross-iteration</span>
<a name="l00629"></a>00629 <span class="comment">     dependences for the kernel.  Therefore the DOALL attribute</span>
<a name="l00630"></a>00630 <span class="comment">     no longer applies. */</span>
<a name="l00631"></a>00631   <span class="keywordflow">if</span> (<a class="code" href="l__softpipe_8c.html#e9b3310fa8a82cd6903c833cef98effd">Lpipe_stage_count</a> &gt; 1)
<a name="l00632"></a>00632     {
<a name="l00633"></a>00633       attr = L_find_attr (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr, <span class="stringliteral">"DOALL"</span>);
<a name="l00634"></a>00634       <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr = L_delete_attr (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr, attr);
<a name="l00635"></a>00635     }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637   <span class="comment">/* Assign rotating register names and annotate the cb</span>
<a name="l00638"></a>00638 <span class="comment">     for register rotation, or unroll the loop and perform MVE.</span>
<a name="l00639"></a>00639 <span class="comment">     Lpipe_gen_rotating_regs only generates the rotating</span>
<a name="l00640"></a>00640 <span class="comment">     registers for the kernel.  The prologue is generated from</span>
<a name="l00641"></a>00641 <span class="comment">     the kernel in Lpipe_multi_epi_gen_rot.  MVE unrolls the loop</span>
<a name="l00642"></a>00642 <span class="comment">     but a later call to Lpipe_multi_epi_gen forms the prologue</span>
<a name="l00643"></a>00643 <span class="comment">     and epilogue from the MVE'ed kernel. */</span>
<a name="l00644"></a>00644 
<a name="l00645"></a>00645   <span class="keywordflow">switch</span> (<a class="code" href="l__pipe__util_8c.html#9929661b757af9845e6325f4752a7d87">Lpipe_schema</a>)
<a name="l00646"></a>00646     {
<a name="l00647"></a>00647     <span class="keywordflow">case</span> <a class="code" href="l__pipe__util_8h.html#3225a520483e53a39cab55104dcd0e5a">REM_LOOP</a>:
<a name="l00648"></a>00648       <a class="code" href="l__mve_8c.html#b3521b99ecff5fb6e631fe1caa6d81bc">Lpipe_mve_transform</a> (sm_cb, unroll);
<a name="l00649"></a>00649       <a class="code" href="l__gen__pipe_8c.html#cf8d2344c93cfbe701567693dc65e006">Lpipe_rem_loop_gen</a> (fn, loop_incr, ii, unroll, <a class="code" href="l__softpipe_8c.html#e9b3310fa8a82cd6903c833cef98effd">Lpipe_stage_count</a>);
<a name="l00650"></a>00650       <a class="code" href="l__pipe__util_8c.html#c7e6b4cf559095203372239c9544b2a8">Lpipe_remove_branches</a> (fn, unroll);
<a name="l00651"></a>00651       <span class="keywordflow">break</span>;
<a name="l00652"></a>00652     <span class="keywordflow">case</span> <a class="code" href="l__pipe__util_8h.html#50a9671342717fc27f66fbb4178f4827">MULTI_EPI</a>:
<a name="l00653"></a>00653       <a class="code" href="l__mve_8c.html#b3521b99ecff5fb6e631fe1caa6d81bc">Lpipe_mve_transform</a> (sm_cb, unroll);
<a name="l00654"></a>00654       <a class="code" href="l__gen__pipe_8c.html#aab08a046531a4539e4a0dbb0f861007">Lpipe_multi_epi_gen</a> (fn, <a class="code" href="l__softpipe_8c.html#e9b3310fa8a82cd6903c833cef98effd">Lpipe_stage_count</a>, loop_back_br, ii, unroll);
<a name="l00655"></a>00655       <span class="comment">/* Fix up live in/out if kernel had to be unrolled for renaming.</span>
<a name="l00656"></a>00656 <span class="comment">         Call these functions even if kernel was not unrolled, because</span>
<a name="l00657"></a>00657 <span class="comment">         they also merge the SSA compensation code blocks into the </span>
<a name="l00658"></a>00658 <span class="comment">         epilogues. */</span>
<a name="l00659"></a>00659       <a class="code" href="l__mve_8c.html#be5df0a0e4bf74c50235e9a87e157c37">Lpipe_fix_live_out</a> (sm_cb, unroll);
<a name="l00660"></a>00660 <span class="preprocessor">#if 0</span>
<a name="l00661"></a>00661 <span class="preprocessor"></span>      <span class="comment">/* Can't do this without working MS dataflow... comments indicate</span>
<a name="l00662"></a>00662 <span class="comment">       * it's not useful now anyway</span>
<a name="l00663"></a>00663 <span class="comment">       */</span>
<a name="l00664"></a>00664       <a class="code" href="l__mve_8c.html#b9b475f6cf9c77cd9d0d58f080c0bef5">Lpipe_fix_live_in</a> (sm_cb);
<a name="l00665"></a>00665 <span class="preprocessor">#endif</span>
<a name="l00666"></a>00666 <span class="preprocessor"></span>      <span class="comment">/* remove empty epilogues */</span>
<a name="l00667"></a>00667       <a class="code" href="l__gen__pipe_8c.html#5b2118879870ec2987266350b965aa44">Lpipe_remove_empty_epilogues</a> (fn, <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>);
<a name="l00668"></a>00668       <span class="keywordflow">break</span>;
<a name="l00669"></a>00669     <span class="keywordflow">case</span> <a class="code" href="l__pipe__util_8h.html#82cbec0da6d1aaa4fc4326173c92f608">MULTI_EPI_ROT_REG</a>:
<a name="l00670"></a>00670       <a class="code" href="l__mve_8c.html#6d37a198558a19c6fc216dc807812c85">Lpipe_rreg_transform</a> (sm_cb);
<a name="l00671"></a>00671       <a class="code" href="l__gen__pipe_8c.html#730dc4cccecf03f47801ce2b86ebb338">Lpipe_multi_epi_gen_rot</a> (sm_cb, loop_back_br);
<a name="l00672"></a>00672       <a class="code" href="l__mve_8c.html#980d54700d750838e30a785314e34805">Lpipe_fix_live_out_rot</a> (sm_cb, sm_loop_back_br);
<a name="l00673"></a>00673       <a class="code" href="l__mve_8c.html#bb2be6c164712e95e8e6126203115def">Lpipe_fix_live_in_rot</a> (sm_cb);
<a name="l00674"></a>00674       <span class="keywordflow">break</span>;
<a name="l00675"></a>00675     <span class="keywordflow">case</span> <a class="code" href="l__pipe__util_8h.html#7c9c77d70fb6ca9475c561bedd2b6b8a">KERNEL_ONLY</a>:
<a name="l00676"></a>00676       <span class="comment">/* Generate kernel-only code.  No epilogues are currently needed,</span>
<a name="l00677"></a>00677 <span class="comment">         but some may in the future. */</span>
<a name="l00678"></a>00678       <a class="code" href="l__mve_8c.html#6d37a198558a19c6fc216dc807812c85">Lpipe_rreg_transform</a> (sm_cb);
<a name="l00679"></a>00679       <a class="code" href="l__gen__pipe_8c.html#719224974bbbb1c9845b638a30cedd93">Lpipe_kernel_gen_rot</a> (sm_cb, loop_back_br);
<a name="l00680"></a>00680       <a class="code" href="l__mve_8c.html#980d54700d750838e30a785314e34805">Lpipe_fix_live_out_rot</a> (sm_cb, sm_loop_back_br);
<a name="l00681"></a>00681       <a class="code" href="l__mve_8c.html#bb2be6c164712e95e8e6126203115def">Lpipe_fix_live_in_rot</a> (sm_cb);
<a name="l00682"></a>00682       <span class="keywordflow">break</span>;
<a name="l00683"></a>00683     <span class="keywordflow">default</span>:
<a name="l00684"></a>00684       L_punt (<span class="stringliteral">"Lpipe_pipeline_loop: Unsupported schema type %d."</span>, 
<a name="l00685"></a>00685               <a class="code" href="l__pipe__util_8c.html#9929661b757af9845e6325f4752a7d87">Lpipe_schema</a>);
<a name="l00686"></a>00686     }
<a name="l00687"></a>00687 
<a name="l00688"></a>00688   <span class="comment">/* adjust sync arcs for the unrolling done by MVE */</span>
<a name="l00689"></a>00689   <span class="keywordflow">if</span> (unroll &gt; 1)
<a name="l00690"></a>00690     L_adjust_syncs_after_unrolling (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>, unroll);
<a name="l00691"></a>00691 
<a name="l00692"></a>00692   <span class="comment">/* Delete latency and mve info */</span>
<a name="l00693"></a>00693   <a class="code" href="l__mve_8c.html#78c3c1d55b2de2cc8d2c30fc73669d6b">Lpipe_free_mve_info</a> ();
<a name="l00694"></a>00694   Lcode_free (MinII);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696   <span class="comment">/* Free arrays of pointers to kernel copies */</span>
<a name="l00697"></a>00697   <span class="keywordflow">if</span> (<a class="code" href="l__softpipe_8c.html#394714920d405996c9ac56376596536a">kernel_copy_first_op</a>)
<a name="l00698"></a>00698     {
<a name="l00699"></a>00699       Lcode_free (<a class="code" href="l__softpipe_8c.html#394714920d405996c9ac56376596536a">kernel_copy_first_op</a>);
<a name="l00700"></a>00700       kernel_copy_first_op = NULL;
<a name="l00701"></a>00701     }
<a name="l00702"></a>00702   <span class="keywordflow">if</span> (<a class="code" href="l__softpipe_8c.html#43dd5bc461bab37b4dc35075227b76df">kernel_copy_last_op</a>)
<a name="l00703"></a>00703     {
<a name="l00704"></a>00704       Lcode_free (<a class="code" href="l__softpipe_8c.html#43dd5bc461bab37b4dc35075227b76df">kernel_copy_last_op</a>);
<a name="l00705"></a>00705       kernel_copy_last_op = NULL;
<a name="l00706"></a>00706     }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708   <a class="codeRef" doxygen="libsm.tag:../../../sched/SM/html/" href="../../../sched/SM/html/sm_8c.html#48459436e1be4f10529483a6c5f6770c">SM_delete_cb</a> (sm_cb);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710   <span class="comment">/* Delete scheduling info for each oper */</span>
<a name="l00711"></a>00711   <a class="code" href="l__softpipe__info_8c.html#62ce42282a593806d185df143094a321">Lpipe_free_op_info</a> (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>);
<a name="l00712"></a>00712 
<a name="l00713"></a>00713   <span class="keywordflow">if</span> (<a class="code" href="l__softpipe_8c.html#e9b3310fa8a82cd6903c833cef98effd">Lpipe_stage_count</a> &gt; 1)
<a name="l00714"></a>00714     {
<a name="l00715"></a>00715       <span class="keywordflow">switch</span> (<a class="code" href="l__pipe__util_8c.html#9929661b757af9845e6325f4752a7d87">Lpipe_schema</a>)
<a name="l00716"></a>00716         {
<a name="l00717"></a>00717         <span class="keywordflow">case</span> <a class="code" href="l__pipe__util_8h.html#3225a520483e53a39cab55104dcd0e5a">REM_LOOP</a>:
<a name="l00718"></a>00718           <a class="code" href="l__softpipe__info_8c.html#62ce42282a593806d185df143094a321">Lpipe_free_op_info</a> (<a class="code" href="l__softpipe_8c.html#4708e528902bf49b9c374df3e644309d">prologue_cb</a>);
<a name="l00719"></a>00719           <a class="code" href="l__softpipe__info_8c.html#62ce42282a593806d185df143094a321">Lpipe_free_op_info</a> (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;next_cb);
<a name="l00720"></a>00720           <span class="keywordflow">break</span>;
<a name="l00721"></a>00721         <span class="keywordflow">case</span> <a class="code" href="l__pipe__util_8h.html#50a9671342717fc27f66fbb4178f4827">MULTI_EPI</a>:
<a name="l00722"></a>00722         <span class="keywordflow">case</span> <a class="code" href="l__pipe__util_8h.html#82cbec0da6d1aaa4fc4326173c92f608">MULTI_EPI_ROT_REG</a>:
<a name="l00723"></a>00723           <a class="code" href="l__softpipe__info_8c.html#62ce42282a593806d185df143094a321">Lpipe_free_op_info</a> (prologue_cb);
<a name="l00724"></a>00724           <span class="keywordflow">for</span> (oper = prologue_cb-&gt;first_op; oper != NULL;
<a name="l00725"></a>00725                oper = oper-&gt;next_op)
<a name="l00726"></a>00726             {
<a name="l00727"></a>00727               <span class="keywordflow">if</span> (L_cond_branch_opcode (oper))
<a name="l00728"></a>00728                 <a class="code" href="l__softpipe__info_8c.html#62ce42282a593806d185df143094a321">Lpipe_free_op_info</a> (L_find_branch_dest (oper));
<a name="l00729"></a>00729             }
<a name="l00730"></a>00730           <span class="comment">/* last exit from header cb is fall through and goes to the </span>
<a name="l00731"></a>00731 <span class="comment">             same epilogue as the last exit from prologue */</span>
<a name="l00732"></a>00732           last_oper = <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;last_op;
<a name="l00733"></a>00733           <span class="keywordflow">for</span> (oper = <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;first_op; oper != last_oper;
<a name="l00734"></a>00734                oper = oper-&gt;next_op)
<a name="l00735"></a>00735             {
<a name="l00736"></a>00736               <span class="keywordflow">if</span> (L_cond_branch_opcode (oper))
<a name="l00737"></a>00737                 <a class="code" href="l__softpipe__info_8c.html#62ce42282a593806d185df143094a321">Lpipe_free_op_info</a> (L_find_branch_dest (oper));
<a name="l00738"></a>00738             }
<a name="l00739"></a>00739           <a class="code" href="l__softpipe__info_8c.html#62ce42282a593806d185df143094a321">Lpipe_free_op_info</a> (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;next_cb);
<a name="l00740"></a>00740           <span class="keywordflow">break</span>;
<a name="l00741"></a>00741         <span class="keywordflow">default</span>:
<a name="l00742"></a>00742           ;
<a name="l00743"></a>00743         }
<a name="l00744"></a>00744     }
<a name="l00745"></a>00745 
<a name="l00746"></a>00746   <span class="keywordflow">return</span> 0;
<a name="l00747"></a>00747 }
<a name="l00748"></a>00748 
<a name="l00749"></a>00749 
<a name="l00750"></a>00750 <span class="comment">/* Modulo schedules all loops in function.  Called by code generator during</span>
<a name="l00751"></a>00751 <span class="comment">   phase 2 just before prepass acyclic code scheduling. */</span>
<a name="l00752"></a>00752 <span class="keywordtype">void</span>
<a name="l00753"></a><a class="code" href="l__softpipe_8h.html#462160b7baa0babe71d4d99a2ea1cacf">00753</a> <a class="code" href="l__softpipe_8c.html#5b303ec4e784e21c2d7d38c47ea63b98">Lpipe_software_pipeline</a> (L_Func * fn)
<a name="l00754"></a>00754 {
<a name="l00755"></a>00755   L_Inner_Loop *loop;
<a name="l00756"></a>00756   L_Attr *attr;
<a name="l00757"></a>00757 
<a name="l00758"></a>00758   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#414f010c3e4a932c6061bb593e7945b0">Lpipe_do_only_postpass_steps</a>)
<a name="l00759"></a>00759     <span class="keywordflow">return</span>;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761   <span class="comment">/*******************************************************************</span>
<a name="l00762"></a>00762 <span class="comment">   * Phase 1: Perform fn-level pred def conversion and global        *</span>
<a name="l00763"></a>00763 <span class="comment">   *          disjoint reg lifetime renaming.                        *</span>
<a name="l00764"></a>00764 <span class="comment">   *          Then perform dataflow and dead code elimination.       *</span>
<a name="l00765"></a>00765 <span class="comment">   ******************************************************************/</span>
<a name="l00766"></a>00766 
<a name="l00767"></a>00767   <span class="comment">/* Transform pred_clear / pred_xx o{t|f} pairs into </span>
<a name="l00768"></a>00768 <span class="comment">     unconditional predicate defines where possible. */</span>
<a name="l00769"></a>00769   <a class="code" href="l__pipe__util_8c.html#8e12dca1f06e9f8f224a39473ba1bb81">Lpipe_create_uncond_pred_defines</a> (fn);
<a name="l00770"></a>00770 
<a name="l00771"></a>00771   <span class="comment">/* To ensure maximum flexibility, break disjoint live</span>
<a name="l00772"></a>00772 <span class="comment">     ranges into distinct virtual registers. */</span>
<a name="l00773"></a>00773   {
<a name="l00774"></a>00774     Set R_rot_reg = <a class="codeRef" doxygen="libregalloc.tag:../../Regalloc/html/" href="../../Regalloc/html/r__regalloc_8c.html#03a8d8fa64ee44840f1b22cf3b942ccb">R_build_rotating_reg_set</a> (fn);
<a name="l00775"></a>00775     <a class="codeRef" doxygen="Lopti.tag:../../../opti/Lopti/html/" href="../../../opti/Lopti/html/l__disjvreg_8c.html#53b6688a9927650d0ff3ff44b2288e9c">L_rename_disjoint_virtual_registers</a> (fn, R_rot_reg);
<a name="l00776"></a>00776     Set_dispose (R_rot_reg);
<a name="l00777"></a>00777   }
<a name="l00778"></a>00778 
<a name="l00779"></a>00779   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ab2140575cdf9b3526e6da5ea095a784">Lpipe_print_statistics</a>)
<a name="l00780"></a>00780     {
<a name="l00781"></a>00781       fprintf (<a class="code" href="l__softpipe_8c.html#d4ad2d89187dec7ea2bbf365f1e10e1e">pipe_statfile</a>,
<a name="l00782"></a>00782                <span class="stringliteral">"\n..Analyze loops for software pipelining in function (%s)\n"</span>,
<a name="l00783"></a>00783                fn-&gt;name);
<a name="l00784"></a>00784     }
<a name="l00785"></a>00785 
<a name="l00786"></a>00786   L_partial_dead_code_removal (fn);
<a name="l00787"></a>00787   L_demote_branches (fn);
<a name="l00788"></a>00788   L_do_flow_analysis (fn, DOMINATOR_CB | LIVE_VARIABLE |
<a name="l00789"></a>00789                       REACHING_DEFINITION | SUPPRESS_PG);
<a name="l00790"></a>00790 
<a name="l00791"></a>00791   L_compute_oper_weight (fn, 0, 1);
<a name="l00792"></a>00792 
<a name="l00793"></a>00793   <span class="comment">/* Detect inner loops and find preheaders. We modulo schedule</span>
<a name="l00794"></a>00794 <span class="comment">     only a single cb, so look for marked header cb.  Full loop detection is</span>
<a name="l00795"></a>00795 <span class="comment">     not designed to be used after superblock formation and superscalar</span>
<a name="l00796"></a>00796 <span class="comment">     optimization, so don't use it here.  For remainder loop, preheader</span>
<a name="l00797"></a>00797 <span class="comment">     and prologue have already been set up, so don't create preheaders. */</span>
<a name="l00798"></a>00798 
<a name="l00799"></a>00799   L_reset_loop_headers (fn);
<a name="l00800"></a>00800   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#9929661b757af9845e6325f4752a7d87">Lpipe_schema</a> == <a class="code" href="l__pipe__util_8h.html#3225a520483e53a39cab55104dcd0e5a">REM_LOOP</a>)
<a name="l00801"></a>00801     {
<a name="l00802"></a>00802       L_punt (<span class="stringliteral">"Lpipe_software_pipeline: Remainder loops unsupported"</span>);
<a name="l00803"></a>00803       L_inner_loop_detection (fn, 0 <span class="comment">/*Do not find preheaders */</span> );
<a name="l00804"></a>00804     }
<a name="l00805"></a>00805   <span class="keywordflow">else</span>
<a name="l00806"></a>00806     {
<a name="l00807"></a>00807       L_inner_loop_detection (fn, 1 <span class="comment">/*Find preheaders */</span> );
<a name="l00808"></a>00808     }
<a name="l00809"></a>00809 
<a name="l00810"></a>00810   <span class="comment">/*******************************************************************</span>
<a name="l00811"></a>00811 <span class="comment">   * Phase 2: Screen loops to softpipe through debugging bounds.     *</span>
<a name="l00812"></a>00812 <span class="comment">   *          Further screen loops through the Lmarkpipe checks.     *</span>
<a name="l00813"></a>00813 <span class="comment">   *          Finally split cbs after the loop back branch and       *</span>
<a name="l00814"></a>00814 <span class="comment">   *          run dataflow.                                          *</span>
<a name="l00815"></a>00815 <span class="comment">   ******************************************************************/</span>
<a name="l00816"></a>00816 
<a name="l00817"></a>00817   <span class="keywordflow">for</span> (loop = fn-&gt;first_inner_loop; loop; loop = loop-&gt;next_inner_loop)
<a name="l00818"></a>00818     {
<a name="l00819"></a>00819       <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a> = loop-&gt;cb;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821       <span class="comment">/* Check if loop is marked for software pipelining */</span>
<a name="l00822"></a>00822       <span class="keywordflow">if</span> (!L_EXTRACT_BIT_VAL (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;flags, L_CB_SOFTPIPE))
<a name="l00823"></a>00823         <span class="keywordflow">continue</span>;
<a name="l00824"></a>00824 
<a name="l00825"></a>00825       <span class="comment">/* Check for loops within target cb bounds */</span>
<a name="l00826"></a>00826       <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ab570eb13a3e6d913d45c8a3b85fad84">Lpipe_debug_use_cb_bounds</a> &amp;&amp;
<a name="l00827"></a>00827           (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;id &lt; <a class="code" href="l__pipe__util_8c.html#4ebe475f1a840fbaa32b10d000fd7f70">Lpipe_debug_lower_cb_bound</a> ||
<a name="l00828"></a>00828            <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;id &gt; <a class="code" href="l__pipe__util_8c.html#9142d5510348648db05b36ee12f6058e">Lpipe_debug_upper_cb_bound</a>))
<a name="l00829"></a>00829         {
<a name="l00830"></a>00830           <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;flags = L_CLR_BIT_FLAG (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;flags, L_CB_SOFTPIPE);
<a name="l00831"></a>00831           <span class="keywordflow">continue</span>;
<a name="l00832"></a>00832         }
<a name="l00833"></a>00833 
<a name="l00834"></a>00834       <span class="comment">/* Check to see if loop is still OK for software pipelining.  This</span>
<a name="l00835"></a>00835 <span class="comment">         is necessary because function calls and writes to macro registers</span>
<a name="l00836"></a>00836 <span class="comment">         can be added during phase 1 annotation. */</span>
<a name="l00837"></a>00837 
<a name="l00838"></a>00838       <span class="keywordflow">if</span> (!Lpipe_is_OK_softpipe_loop (loop, <a class="code" href="l__softpipe_8c.html#d4ad2d89187dec7ea2bbf365f1e10e1e">pipe_statfile</a>, 
<a name="l00839"></a>00839                                       &amp;<a class="code" href="l__softpipe_8c.html#e41610bb03edbaeb7c02cfcc7fc4467b">Lpipe_counted_loop</a>, 0))
<a name="l00840"></a>00840         {
<a name="l00841"></a>00841           <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ab2140575cdf9b3526e6da5ea095a784">Lpipe_print_statistics</a>)
<a name="l00842"></a>00842             fprintf (<a class="code" href="l__softpipe_8c.html#d4ad2d89187dec7ea2bbf365f1e10e1e">pipe_statfile</a>, <span class="stringliteral">":( Loop with header cb %d no "</span>
<a name="l00843"></a>00843                      <span class="stringliteral">"longer OK for software pipelining\n"</span>, <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;id);
<a name="l00844"></a>00844           <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;flags = L_CLR_BIT_FLAG (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;flags, L_CB_SOFTPIPE);
<a name="l00845"></a>00845           <span class="keywordflow">continue</span>;
<a name="l00846"></a>00846         }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848       <span class="keywordflow">if</span> (loop-&gt;feedback_op-&gt;id != loop-&gt;cb-&gt;last_op-&gt;id)
<a name="l00849"></a>00849         <a class="codeRef" doxygen="Lopti.tag:../../../opti/Lopti/html/" href="../../../opti/Lopti/html/l__opti__functions_8c.html#c67d6a549e966629413a6590e7746676">L_split_cb_after</a> (fn, loop-&gt;cb, loop-&gt;feedback_op);
<a name="l00850"></a>00850 
<a name="l00851"></a>00851       <span class="comment">/* Remove impossible sync arcs */</span>
<a name="l00852"></a>00852       L_adjust_invalid_sync_arcs_in_cb (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>);
<a name="l00853"></a>00853     }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855   <span class="comment">/* JWS 20001115</span>
<a name="l00856"></a>00856 <span class="comment">   * Must do infinite lifetime repair before final</span>
<a name="l00857"></a>00857 <span class="comment">   * dataflow analysis to ensure all resulting truly disjoint </span>
<a name="l00858"></a>00858 <span class="comment">   * LpipeLiveRanges are split.  Furthermore, the kernel</span>
<a name="l00859"></a>00859 <span class="comment">   * attribute must be attached after fix_infinite_lifetimes</span>
<a name="l00860"></a>00860 <span class="comment">   * but before the next call to dataflow, so that complete</span>
<a name="l00861"></a>00861 <span class="comment">   * write moves do not get deleted.</span>
<a name="l00862"></a>00862 <span class="comment">   */</span>
<a name="l00863"></a>00863 
<a name="l00864"></a>00864   L_partial_dead_code_removal (fn);
<a name="l00865"></a>00865   L_demote_branches (fn);
<a name="l00866"></a>00866   L_do_flow_analysis (fn, LIVE_VARIABLE | SUPPRESS_PG);
<a name="l00867"></a>00867 
<a name="l00868"></a>00868   <span class="comment">/*******************************************************************</span>
<a name="l00869"></a>00869 <span class="comment">   * Phase 3: Fix all infinite lifetimes so rotating registers work  *</span>
<a name="l00870"></a>00870 <span class="comment">   *          correctly, then rename disjoint lifetimes in loop      *</span>
<a name="l00871"></a>00871 <span class="comment">   *          Finanally, run dataflow.                               *</span>
<a name="l00872"></a>00872 <span class="comment">   ******************************************************************/</span>
<a name="l00873"></a>00873 
<a name="l00874"></a>00874   <span class="keywordflow">for</span> (loop = fn-&gt;first_inner_loop; loop; loop = loop-&gt;next_inner_loop)
<a name="l00875"></a>00875     {
<a name="l00876"></a>00876       <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a> = loop-&gt;cb;
<a name="l00877"></a>00877 
<a name="l00878"></a>00878       <span class="keywordflow">if</span> (!L_EXTRACT_BIT_VAL (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;flags, L_CB_SOFTPIPE))
<a name="l00879"></a>00879         <span class="keywordflow">continue</span>;
<a name="l00880"></a>00880 
<a name="l00881"></a>00881       <a class="code" href="l__pipe__rename_8c.html#7dc8d4655a2ef52a3198fafa93d3ab1a">Lpipe_fix_infinite_lifetimes</a> (fn, <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>);
<a name="l00882"></a>00882       <a class="code" href="l__pipe__rename_8c.html#fffde84a48fda4a4a865640c272c2220">Lpipe_create_comp_code_blocks</a> (fn, loop);
<a name="l00883"></a>00883       <a class="code" href="l__pipe__rename_8c.html#f87757396ae9cd301b0f54e3871e342a">Lpipe_rename_defined_macros</a> (fn, loop);
<a name="l00884"></a>00884     }
<a name="l00885"></a>00885 
<a name="l00886"></a>00886   L_do_flow_analysis (fn, DOMINATOR_CB | LIVE_VARIABLE | REACHING_DEFINITION);
<a name="l00887"></a>00887 
<a name="l00888"></a>00888   <span class="keywordflow">for</span> (loop = fn-&gt;first_inner_loop; loop; loop = loop-&gt;next_inner_loop)
<a name="l00889"></a>00889     {
<a name="l00890"></a>00890       L_Oper *loop_back_br;
<a name="l00891"></a>00891       <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a> = loop-&gt;cb;
<a name="l00892"></a>00892 
<a name="l00893"></a>00893       <span class="comment">/* Check if loop is marked for software pipelining */</span>
<a name="l00894"></a>00894       <span class="keywordflow">if</span> (!L_EXTRACT_BIT_VAL (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;flags, L_CB_SOFTPIPE))
<a name="l00895"></a>00895         <span class="keywordflow">continue</span>;
<a name="l00896"></a>00896 
<a name="l00897"></a>00897       <span class="comment">/* find loop back branch */</span>
<a name="l00898"></a>00898       loop_back_br = loop-&gt;feedback_op;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900       attr = L_new_attr (<span class="stringliteral">"kernel"</span>, 0);
<a name="l00901"></a>00901       <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr = L_concat_attr (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr, attr);
<a name="l00902"></a>00902 
<a name="l00903"></a>00903       <span class="comment">/* Ensure that each virtual register has only one lifetime. */</span>
<a name="l00904"></a>00904       <a class="code" href="l__pipe__rename_8c.html#c5fcbc92b251c0f8652e1aef2f1ea203">Lpipe_rename_disj_vregs_in_loop</a> (fn, loop);
<a name="l00905"></a>00905 
<a name="l00906"></a>00906       <span class="comment">/* Check if L_CB_SOFTPIPE flag reset because of infinite lifetime */</span>
<a name="l00907"></a>00907       <span class="keywordflow">if</span> (!L_EXTRACT_BIT_VAL (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;flags, L_CB_SOFTPIPE))
<a name="l00908"></a>00908         {
<a name="l00909"></a>00909           <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#ab2140575cdf9b3526e6da5ea095a784">Lpipe_print_statistics</a>)
<a name="l00910"></a>00910             fprintf (<a class="code" href="l__softpipe_8c.html#d4ad2d89187dec7ea2bbf365f1e10e1e">pipe_statfile</a>, <span class="stringliteral">":([ Loop with header cb %d has infinite "</span>
<a name="l00911"></a>00911                      <span class="stringliteral">"lifetime.  Cannot software pipeline.\n"</span>, <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;id);
<a name="l00912"></a>00912           <span class="keywordflow">continue</span>;
<a name="l00913"></a>00913         }
<a name="l00914"></a>00914     }
<a name="l00915"></a>00915 
<a name="l00916"></a>00916   L_partial_dead_code_removal (fn);
<a name="l00917"></a>00917   L_demote_branches (fn);
<a name="l00918"></a>00918   L_do_flow_analysis (fn, DOMINATOR_CB | LIVE_VARIABLE |
<a name="l00919"></a>00919                       REACHING_DEFINITION | SUPPRESS_PG);
<a name="l00920"></a>00920   L_compute_oper_weight (fn, 0, 1);
<a name="l00921"></a>00921 
<a name="l00922"></a>00922   <span class="comment">/*******************************************************************</span>
<a name="l00923"></a>00923 <span class="comment">   * Phase 4: Pipeline each loop.                                    *</span>
<a name="l00924"></a>00924 <span class="comment">   ******************************************************************/</span>
<a name="l00925"></a>00925 
<a name="l00926"></a>00926   <span class="keywordflow">for</span> (loop = fn-&gt;first_inner_loop; loop; loop = loop-&gt;next_inner_loop)
<a name="l00927"></a>00927     {
<a name="l00928"></a>00928       <span class="keywordflow">if</span> (!L_EXTRACT_BIT_VAL (loop-&gt;cb-&gt;flags, L_CB_SOFTPIPE))
<a name="l00929"></a>00929         <span class="keywordflow">continue</span>;
<a name="l00930"></a>00930       <a class="code" href="l__softpipe_8c.html#cd9bb1e732e6b1dd2cb4071650da8534">Lpipe_pipeline_loop</a> (fn, loop);
<a name="l00931"></a>00931     }
<a name="l00932"></a>00932 
<a name="l00933"></a>00933   <span class="comment">/*******************************************************************</span>
<a name="l00934"></a>00934 <span class="comment">   * Phase 5: Insert defines to protect rotating register lifetimes  *</span>
<a name="l00935"></a>00935 <span class="comment">   *          and perform cleanup steps.                             *</span>
<a name="l00936"></a>00936 <span class="comment">   ******************************************************************/</span>
<a name="l00937"></a>00937 
<a name="l00938"></a>00938   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#9929661b757af9845e6325f4752a7d87">Lpipe_schema</a> == <a class="code" href="l__pipe__util_8h.html#82cbec0da6d1aaa4fc4326173c92f608">MULTI_EPI_ROT_REG</a> || <a class="code" href="l__pipe__util_8c.html#9929661b757af9845e6325f4752a7d87">Lpipe_schema</a> == <a class="code" href="l__pipe__util_8h.html#7c9c77d70fb6ca9475c561bedd2b6b8a">KERNEL_ONLY</a>)
<a name="l00939"></a>00939     {
<a name="l00940"></a>00940       <span class="comment">/* Allocate the rotating registers in chunks as specified by the</span>
<a name="l00941"></a>00941 <span class="comment">         bank settings and create the operand defines to ensure</span>
<a name="l00942"></a>00942 <span class="comment">         correct live range analysis. */</span>
<a name="l00943"></a>00943       <a class="code" href="l__pipe__util_8c.html#e541b9878cec8748cd7882ee97c7ba4f">Lpipe_delete_defines</a> (fn);
<a name="l00944"></a>00944       <a class="code" href="l__pipe__util_8c.html#689850f1f56bc56b23c950658e5aba87">Lpipe_create_defines</a> (fn);
<a name="l00945"></a>00945 
<a name="l00946"></a>00946       L_partial_dead_code_removal (fn);
<a name="l00947"></a>00947       L_do_flow_analysis (fn, DOMINATOR_CB | REACHING_DEFINITION);
<a name="l00948"></a>00948 
<a name="l00949"></a>00949       L_inner_loop_detection (fn, 0);
<a name="l00950"></a>00950 
<a name="l00951"></a>00951       <a class="code" href="l__pipe__util_8c.html#08dd82ece7672006298b40e75a866e6b">Lpipe_reduce_defines</a> (fn);
<a name="l00952"></a>00952 
<a name="l00953"></a>00953       <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#33aa768a71f08754b1273f95c0cf1d2f">Lpipe_combine_cbs</a>)
<a name="l00954"></a>00954         {
<a name="l00955"></a>00955           <span class="comment">/* Remainder loop and MVE schemas require the prologue attribute</span>
<a name="l00956"></a>00956 <span class="comment">             to be present on said cb.  These optis often merge the prologue</span>
<a name="l00957"></a>00957 <span class="comment">             into the previous cb and eliminate that attribute. */</span>
<a name="l00958"></a>00958           <a class="codeRef" doxygen="Lopti.tag:../../../opti/Lopti/html/" href="../../../opti/Lopti/html/l__jump__opti_8c.html#bfe7e119c00d82dac2c19d9ffce4b648">L_jump_elim_branch_to_next_block</a> (fn, 0);
<a name="l00959"></a>00959           <a class="codeRef" doxygen="Lopti.tag:../../../opti/Lopti/html/" href="../../../opti/Lopti/html/l__jump__opti_8c.html#84f246633d5116b6351ab4784c228ffc">L_jump_combine_branch_to_uncond_branch</a> (fn, 0);
<a name="l00960"></a>00960           <a class="codeRef" doxygen="Lopti.tag:../../../opti/Lopti/html/" href="../../../opti/Lopti/html/l__jump__opti_8c.html#5ab6683acf0262a56817e0bd82d5e1ca">L_jump_merge_always_successive_blocks</a> (fn, 0);
<a name="l00961"></a>00961           <a class="codeRef" doxygen="Lopti.tag:../../../opti/Lopti/html/" href="../../../opti/Lopti/html/l__jump__opti_8c.html#052b0aca2df7b58bbcdbddb7641c4ab4">L_jump_combine_labels</a> (fn, 0);
<a name="l00962"></a>00962           <a class="codeRef" doxygen="Lopti.tag:../../../opti/Lopti/html/" href="../../../opti/Lopti/html/l__jump__opti_8c.html#e742334867e69335d1a29803779e5730">L_jump_branch_target_expansion</a> (fn, 0);
<a name="l00963"></a>00963         }
<a name="l00964"></a>00964     }
<a name="l00965"></a>00965 
<a name="l00966"></a>00966   L_set_hb_no_fallthru_flag (fn);
<a name="l00967"></a>00967 
<a name="l00968"></a>00968   <span class="keywordflow">return</span>;
<a name="l00969"></a>00969 }
<a name="l00970"></a>00970 
<a name="l00971"></a>00971 
<a name="l00972"></a>00972 <span class="comment">/* Search each software pipelined loop for spill code.  If spill code is </span>
<a name="l00973"></a>00973 <span class="comment">   found, reset software pipelining flag so that acyclic scheduler can </span>
<a name="l00974"></a>00974 <span class="comment">   schedule the spill code.  Called by code generator right after register </span>
<a name="l00975"></a>00975 <span class="comment">   allocation. */</span>
<a name="l00976"></a>00976 
<a name="l00977"></a>00977 <span class="keywordtype">void</span>
<a name="l00978"></a><a class="code" href="l__softpipe_8h.html#069ce3dfcfa7ef2d0e36b64aa8348cb3">00978</a> <a class="code" href="l__softpipe_8c.html#1240d252386c4bb4d5f9bc08a7c2039e">Lpipe_mark_loops_with_spills</a> (L_Func * fn)
<a name="l00979"></a>00979 {
<a name="l00980"></a>00980   L_Inner_Loop *loop;
<a name="l00981"></a>00981   L_Cb *cb, *next_cb, *epilogue_cb, *<a class="code" href="l__softpipe_8c.html#4708e528902bf49b9c374df3e644309d">prologue_cb</a>,
<a name="l00982"></a>00982     *rem_epi_cb = NULL, *rem_loop_cb = NULL, *first_cb = NULL;
<a name="l00983"></a>00983   L_Oper *oper;
<a name="l00984"></a>00984   L_Attr *attr;
<a name="l00985"></a>00985   <span class="keywordtype">int</span> <a class="codeRef" doxygen="Lopti.tag:../../../opti/Lopti/html/" href="../../../opti/Lopti/html/l__benchmark__opti_8c.html#fe78219112b6a7feb42f7349266dd872">num_cb</a>, num_int_spills, num_flt_spills, num_dbl_spills, has_spills,
<a name="l00986"></a>00986     spill_opers, swp, num_opers, rem_num_opers, reroll_num_opers,
<a name="l00987"></a>00987     ko_num_opers, rem_ko_num_opers, reroll_ko_num_opers,
<a name="l00988"></a>00988     has_rem_loop, acyclic, rem_epi_found, rem_loop_found, reroll = -1;
<a name="l00989"></a>00989   <span class="keywordtype">double</span> dyn_spill_opers;
<a name="l00990"></a>00990 
<a name="l00991"></a>00991   <span class="comment">/* 20031023 SZU</span>
<a name="l00992"></a>00992 <span class="comment">   * Removed for Limpact to work. Don't see reason for restriction.</span>
<a name="l00993"></a>00993 <span class="comment">   */</span>
<a name="l00994"></a>00994   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#9929661b757af9845e6325f4752a7d87">Lpipe_schema</a> == <a class="code" href="l__pipe__util_8h.html#7c9c77d70fb6ca9475c561bedd2b6b8a">KERNEL_ONLY</a>)
<a name="l00995"></a>00995     <span class="keywordflow">return</span>;
<a name="l00996"></a>00996 
<a name="l00997"></a>00997   L_inner_loop_detection (fn, 0);
<a name="l00998"></a>00998   L_compute_oper_weight (fn, 0, 1);
<a name="l00999"></a>00999 
<a name="l01000"></a>01000   <span class="keywordflow">for</span> (loop = fn-&gt;first_inner_loop; loop; loop = loop-&gt;next_inner_loop)
<a name="l01001"></a>01001     {
<a name="l01002"></a>01002       cb = loop-&gt;cb;
<a name="l01003"></a>01003 
<a name="l01004"></a>01004 <span class="preprocessor">#ifdef LP64_ARCHITECTURE</span>
<a name="l01005"></a>01005 <span class="preprocessor"></span>      has_rem_loop = (int)((<span class="keywordtype">long</span>)L_find_attr (cb-&gt;attr, <span class="stringliteral">"has_rem_loop"</span>));
<a name="l01006"></a>01006       acyclic = (int)((<span class="keywordtype">long</span>)L_find_attr (cb-&gt;attr, <span class="stringliteral">"L_CB_SOFTPIPE"</span>));
<a name="l01007"></a>01007 <span class="preprocessor">#else</span>
<a name="l01008"></a>01008 <span class="preprocessor"></span>      has_rem_loop = (int) L_find_attr (cb-&gt;attr, <span class="stringliteral">"has_rem_loop"</span>);
<a name="l01009"></a>01009       acyclic = (int) L_find_attr (cb-&gt;attr, <span class="stringliteral">"L_CB_SOFTPIPE"</span>);
<a name="l01010"></a>01010 <span class="preprocessor">#endif</span>
<a name="l01011"></a>01011 <span class="preprocessor"></span>
<a name="l01012"></a>01012       <span class="keywordflow">if</span> (L_EXTRACT_BIT_VAL (cb-&gt;flags, L_CB_SOFTPIPE) || acyclic)
<a name="l01013"></a>01013         {
<a name="l01014"></a>01014           has_spills = 0;
<a name="l01015"></a>01015           num_int_spills = 0;
<a name="l01016"></a>01016           num_flt_spills = 0;
<a name="l01017"></a>01017           num_dbl_spills = 0;
<a name="l01018"></a>01018           num_opers = 0;
<a name="l01019"></a>01019           ko_num_opers = 0;
<a name="l01020"></a>01020           <span class="keywordflow">for</span> (oper = cb-&gt;first_op; oper != NULL; oper = oper-&gt;next_op)
<a name="l01021"></a>01021             {
<a name="l01022"></a>01022               <span class="keywordflow">if</span> (L_EXTRACT_BIT_VAL (oper-&gt;flags, L_OPER_SPILL_CODE))
<a name="l01023"></a>01023                 {
<a name="l01024"></a>01024                   <span class="keywordflow">if</span> (L_int_load_opcode (oper) || L_int_store_opcode (oper) ||
<a name="l01025"></a>01025                       L_int_move_opcode (oper))
<a name="l01026"></a>01026                     num_int_spills++;
<a name="l01027"></a>01027                   <span class="keywordflow">if</span> (L_flt_load_opcode (oper) || L_flt_store_opcode (oper) ||
<a name="l01028"></a>01028                       L_flt_move_opcode (oper))
<a name="l01029"></a>01029                     num_flt_spills++;
<a name="l01030"></a>01030                   <span class="keywordflow">if</span> (L_dbl_load_opcode (oper) || L_dbl_store_opcode (oper) ||
<a name="l01031"></a>01031                       L_dbl_move_opcode (oper))
<a name="l01032"></a>01032                     num_dbl_spills++;
<a name="l01033"></a>01033                   has_spills = 1;
<a name="l01034"></a>01034                 }
<a name="l01035"></a>01035               num_opers++;
<a name="l01036"></a>01036 
<a name="l01037"></a>01037               <span class="keywordflow">if</span> (acyclic ||
<a name="l01038"></a>01038                   ((attr = L_find_attr (oper-&gt;attr, <span class="stringliteral">"iter"</span>)) &amp;&amp;
<a name="l01039"></a>01039                    (attr-&gt;field[0]-&gt;value.i == 1)))
<a name="l01040"></a>01040                 ko_num_opers++;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042               <span class="keywordflow">if</span> (L_cond_branch_opcode (oper))
<a name="l01043"></a>01043                 {
<a name="l01044"></a>01044                   epilogue_cb = (oper == cb-&gt;last_op) ? cb-&gt;next_cb : 
<a name="l01045"></a>01045                     L_find_branch_dest (oper);
<a name="l01046"></a>01046 
<a name="l01047"></a>01047                   <span class="keywordflow">if</span> (L_find_attr (epilogue_cb-&gt;attr, <span class="stringliteral">"epilogue"</span>))
<a name="l01048"></a>01048                     num_opers += L_cb_size (epilogue_cb);
<a name="l01049"></a>01049                 }
<a name="l01050"></a>01050             }
<a name="l01051"></a>01051 
<a name="l01052"></a>01052           prologue_cb = cb-&gt;prev_cb;
<a name="l01053"></a>01053 
<a name="l01054"></a>01054           <span class="keywordflow">if</span> (L_find_attr (prologue_cb-&gt;attr, <span class="stringliteral">"prologue"</span>))
<a name="l01055"></a>01055             {
<a name="l01056"></a>01056               <span class="keywordflow">for</span> (oper = prologue_cb-&gt;first_op; oper != NULL;
<a name="l01057"></a>01057                    oper = oper-&gt;next_op)
<a name="l01058"></a>01058                 {
<a name="l01059"></a>01059                   num_opers++;
<a name="l01060"></a>01060 
<a name="l01061"></a>01061                   <span class="keywordflow">if</span> (L_cond_branch_opcode (oper))
<a name="l01062"></a>01062                     {
<a name="l01063"></a>01063                       epilogue_cb = L_find_branch_dest (oper);
<a name="l01064"></a>01064 
<a name="l01065"></a>01065                       <span class="keywordflow">if</span> (L_find_attr (epilogue_cb-&gt;attr, <span class="stringliteral">"epilogue"</span>) &amp;&amp;
<a name="l01066"></a>01066                           epilogue_cb != cb-&gt;next_cb)
<a name="l01067"></a>01067                         num_opers += L_cb_size (epilogue_cb);
<a name="l01068"></a>01068                     }
<a name="l01069"></a>01069                 }
<a name="l01070"></a>01070             }
<a name="l01071"></a>01071           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((!L_find_attr (cb-&gt;attr, <span class="stringliteral">"L_CB_SOFTPIPE"</span>)) &amp;&amp;
<a name="l01072"></a>01072                    (!(L_EXTRACT_BIT_VAL (cb-&gt;flags, L_CB_SOFTPIPE))))
<a name="l01073"></a>01073             {
<a name="l01074"></a>01074               L_punt (<span class="stringliteral">"Lpipe_mark_loops_with_spills: "</span>
<a name="l01075"></a>01075                       <span class="stringliteral">"Expected to find prologue attribute, but did not.  "</span>
<a name="l01076"></a>01076                       <span class="stringliteral">"Cb: %d, Function: %s\n"</span>, prologue_cb-&gt;id, fn-&gt;name);
<a name="l01077"></a>01077             }
<a name="l01078"></a>01078 
<a name="l01079"></a>01079           <span class="keywordflow">if</span> (has_spills)
<a name="l01080"></a>01080             {
<a name="l01081"></a>01081               cb-&gt;flags = L_CLR_BIT_FLAG (cb-&gt;flags, L_CB_SOFTPIPE);
<a name="l01082"></a>01082 
<a name="l01083"></a>01083               <span class="comment">/* if flag was cleared, need to remove isl attributes since </span>
<a name="l01084"></a>01084 <span class="comment">                 acyclic scheduler will add them */</span>
<a name="l01085"></a>01085               <span class="keywordflow">for</span> (oper = cb-&gt;first_op; oper != NULL; oper = oper-&gt;next_op)
<a name="l01086"></a>01086                 {
<a name="l01087"></a>01087                   <span class="keywordflow">if</span> ((attr = L_find_attr (oper-&gt;attr, <span class="stringliteral">"isl"</span>)))
<a name="l01088"></a>01088                     oper-&gt;attr = L_delete_attr (oper-&gt;attr, attr);
<a name="l01089"></a>01089                 }
<a name="l01090"></a>01090             }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092           rem_num_opers = num_opers;
<a name="l01093"></a>01093           rem_ko_num_opers = ko_num_opers;
<a name="l01094"></a>01094           reroll_num_opers = num_opers;
<a name="l01095"></a>01095           reroll_ko_num_opers = ko_num_opers;
<a name="l01096"></a>01096 
<a name="l01097"></a>01097           <span class="keywordflow">if</span> (has_rem_loop)
<a name="l01098"></a>01098             {
<a name="l01099"></a>01099               <span class="keywordflow">for</span> (next_cb = cb-&gt;next_cb; next_cb != NULL;
<a name="l01100"></a>01100                    next_cb = next_cb-&gt;next_cb)
<a name="l01101"></a>01101                 {
<a name="l01102"></a>01102                   <span class="keywordflow">if</span> (!(attr = L_find_attr (next_cb-&gt;attr, <span class="stringliteral">"epilogue"</span>)))
<a name="l01103"></a>01103                     {
<a name="l01104"></a>01104                       first_cb = next_cb;
<a name="l01105"></a>01105                       <span class="keywordflow">break</span>;
<a name="l01106"></a>01106                     }
<a name="l01107"></a>01107                 }
<a name="l01108"></a>01108 
<a name="l01109"></a>01109               rem_epi_found = 0;
<a name="l01110"></a>01110               num_cb = 0;
<a name="l01111"></a>01111               <span class="keywordflow">for</span> (; next_cb != NULL; next_cb = next_cb-&gt;next_cb)
<a name="l01112"></a>01112                 {
<a name="l01113"></a>01113                   num_cb++;
<a name="l01114"></a>01114                   attr = L_find_attr (next_cb-&gt;attr, <span class="stringliteral">"rem_epilogue"</span>);
<a name="l01115"></a>01115                   <span class="keywordflow">if</span> (attr != NULL &amp;&amp; attr-&gt;field[0]-&gt;value.i == cb-&gt;id)
<a name="l01116"></a>01116                     {
<a name="l01117"></a>01117                       rem_epi_found = 1;
<a name="l01118"></a>01118                       rem_epi_cb = next_cb;
<a name="l01119"></a>01119                       <span class="keywordflow">break</span>;
<a name="l01120"></a>01120                     }
<a name="l01121"></a>01121                 }
<a name="l01122"></a>01122 
<a name="l01123"></a>01123               <span class="keywordflow">if</span> (!rem_epi_found)
<a name="l01124"></a>01124                 {
<a name="l01125"></a>01125                   L_punt (<span class="stringliteral">"Lpipe_mark_loops_with_spills: "</span>
<a name="l01126"></a>01126                           <span class="stringliteral">"could not find epilogue for remainder loop.  "</span>
<a name="l01127"></a>01127                           <span class="stringliteral">"cb: %d, function: %s\n"</span>, cb-&gt;id, fn-&gt;name);
<a name="l01128"></a>01128                 }
<a name="l01129"></a>01129               <span class="keywordflow">if</span> (num_cb &gt; 4)
<a name="l01130"></a>01130                 {
<a name="l01131"></a>01131                   L_punt (<span class="stringliteral">"Lpipe_mark_loops_with_spills: "</span>
<a name="l01132"></a>01132                           <span class="stringliteral">"epilogue for remainder loop more than 4 cbs "</span>
<a name="l01133"></a>01133                           <span class="stringliteral">"after original loop.  cb: %d, function: %s\n"</span>,
<a name="l01134"></a>01134                           cb-&gt;id, fn-&gt;name);
<a name="l01135"></a>01135                 }
<a name="l01136"></a>01136 
<a name="l01137"></a>01137               rem_loop_found = 0;
<a name="l01138"></a>01138               num_cb = 0;
<a name="l01139"></a>01139               <span class="keywordflow">for</span> (; next_cb != NULL; next_cb = next_cb-&gt;next_cb)
<a name="l01140"></a>01140                 {
<a name="l01141"></a>01141                   num_cb++;
<a name="l01142"></a>01142                   attr = L_find_attr (next_cb-&gt;attr, <span class="stringliteral">"rem_loop"</span>);
<a name="l01143"></a>01143                   <span class="keywordflow">if</span> (attr != NULL &amp;&amp; attr-&gt;field[0]-&gt;value.i == cb-&gt;id)
<a name="l01144"></a>01144                     {
<a name="l01145"></a>01145                       rem_loop_found = 1;
<a name="l01146"></a>01146                       rem_loop_cb = next_cb;
<a name="l01147"></a>01147                       <span class="keywordflow">break</span>;
<a name="l01148"></a>01148                     }
<a name="l01149"></a>01149                 }
<a name="l01150"></a>01150 
<a name="l01151"></a>01151               <span class="keywordflow">if</span> (!rem_loop_found)
<a name="l01152"></a>01152                 {
<a name="l01153"></a>01153                   <span class="comment">/* ITI/MCM Certain optimizations move the rem_loop</span>
<a name="l01154"></a>01154 <span class="comment">                     up above the rem_epilogue and modulo scheduled</span>
<a name="l01155"></a>01155 <span class="comment">                     loop.  Since this is for statistics only, skip</span>
<a name="l01156"></a>01156 <span class="comment">                     the remaining code in the has_rem_loop if</span>
<a name="l01157"></a>01157 <span class="comment">                     conditional. */</span>
<a name="l01158"></a>01158 <span class="preprocessor">#if 0</span>
<a name="l01159"></a>01159 <span class="preprocessor"></span>                  L_punt (<span class="stringliteral">"Lpipe_mark_loops_with_spills: "</span>
<a name="l01160"></a>01160                           <span class="stringliteral">"could not find remainder loop.  "</span>
<a name="l01161"></a>01161                           <span class="stringliteral">"cb: %d, function: %s\n"</span>, cb-&gt;id, fn-&gt;name);
<a name="l01162"></a>01162 <span class="preprocessor">#endif</span>
<a name="l01163"></a>01163 <span class="preprocessor"></span>                  has_rem_loop = 0;
<a name="l01164"></a>01164                 }
<a name="l01165"></a>01165             }
<a name="l01166"></a>01166 
<a name="l01167"></a>01167           <span class="keywordflow">if</span> (has_rem_loop)
<a name="l01168"></a>01168             {
<a name="l01169"></a>01169               <span class="keywordflow">for</span> (next_cb = first_cb; next_cb != rem_loop_cb;
<a name="l01170"></a>01170                    next_cb = next_cb-&gt;next_cb)
<a name="l01171"></a>01171                 {
<a name="l01172"></a>01172                   rem_num_opers += L_cb_size (next_cb);
<a name="l01173"></a>01173                   rem_ko_num_opers += L_cb_size (next_cb);
<a name="l01174"></a>01174                 }
<a name="l01175"></a>01175 
<a name="l01176"></a>01176               rem_num_opers += L_cb_size (rem_loop_cb);
<a name="l01177"></a>01177               rem_ko_num_opers += L_cb_size (rem_loop_cb);
<a name="l01178"></a>01178 
<a name="l01179"></a>01179               attr = L_find_attr (rem_loop_cb-&gt;attr, <span class="stringliteral">"reroll"</span>);
<a name="l01180"></a>01180 <span class="preprocessor">#ifdef LP64_ARCHITECTURE</span>
<a name="l01181"></a>01181 <span class="preprocessor"></span>              reroll = (int)((<span class="keywordtype">long</span>)attr);
<a name="l01182"></a>01182 <span class="preprocessor">#else</span>
<a name="l01183"></a>01183 <span class="preprocessor"></span>              reroll = (int) attr;
<a name="l01184"></a>01184 <span class="preprocessor">#endif</span>
<a name="l01185"></a>01185 <span class="preprocessor"></span>
<a name="l01186"></a>01186               <span class="keywordflow">if</span> (reroll)
<a name="l01187"></a>01187                 {
<a name="l01188"></a>01188                   <span class="keywordflow">for</span> (next_cb = first_cb; next_cb != rem_epi_cb;
<a name="l01189"></a>01189                        next_cb = next_cb-&gt;next_cb)
<a name="l01190"></a>01190                     {
<a name="l01191"></a>01191                       reroll_num_opers += L_cb_size (next_cb);
<a name="l01192"></a>01192                       reroll_ko_num_opers += L_cb_size (next_cb);
<a name="l01193"></a>01193                     }
<a name="l01194"></a>01194 
<a name="l01195"></a>01195                   <span class="keywordflow">for</span> (oper = rem_epi_cb-&gt;first_op; oper != NULL;
<a name="l01196"></a>01196                        oper = oper-&gt;next_op)
<a name="l01197"></a>01197                     {
<a name="l01198"></a>01198                       reroll_num_opers++;
<a name="l01199"></a>01199                       reroll_ko_num_opers++;
<a name="l01200"></a>01200                       <span class="keywordflow">if</span> (L_cond_branch_opcode (oper))
<a name="l01201"></a>01201                         <span class="keywordflow">break</span>;
<a name="l01202"></a>01202                     }
<a name="l01203"></a>01203 
<a name="l01204"></a>01204                   reroll_num_opers += attr-&gt;field[0]-&gt;value.i;
<a name="l01205"></a>01205                   reroll_ko_num_opers += attr-&gt;field[0]-&gt;value.i;
<a name="l01206"></a>01206                 }
<a name="l01207"></a>01207               <span class="keywordflow">else</span>
<a name="l01208"></a>01208                 {
<a name="l01209"></a>01209                   reroll_num_opers = rem_num_opers;
<a name="l01210"></a>01210                   reroll_ko_num_opers = rem_ko_num_opers;
<a name="l01211"></a>01211                 }
<a name="l01212"></a>01212             }
<a name="l01213"></a>01213 
<a name="l01214"></a>01214           <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#e2d1368da174d6c3c8b7ec7d1cbbf44e">Lpipe_add_spill_attributes</a>)
<a name="l01215"></a>01215             {
<a name="l01216"></a>01216               attr = L_new_attr (<span class="stringliteral">"code_size"</span>, 1);
<a name="l01217"></a>01217               L_set_int_attr_field (attr, 0, num_opers);
<a name="l01218"></a>01218               cb-&gt;attr = L_concat_attr (cb-&gt;attr, attr);
<a name="l01219"></a>01219               attr = L_new_attr (<span class="stringliteral">"int_flt_dbl_spills"</span>, 3);
<a name="l01220"></a>01220               L_set_int_attr_field (attr, 0, num_int_spills);
<a name="l01221"></a>01221               L_set_int_attr_field (attr, 1, num_flt_spills);
<a name="l01222"></a>01222               L_set_int_attr_field (attr, 2, num_dbl_spills);
<a name="l01223"></a>01223               cb-&gt;attr = L_concat_attr (cb-&gt;attr, attr);
<a name="l01224"></a>01224 
<a name="l01225"></a>01225               fprintf (<a class="code" href="l__softpipe_8c.html#b31a94b2b54c2bff51947401462afb8a">spill_statfile</a>, <span class="stringliteral">"\n"</span>);
<a name="l01226"></a>01226               attr = L_find_attr (cb-&gt;attr, <span class="stringliteral">"LOOP"</span>);
<a name="l01227"></a>01227               <span class="comment">/* print source line number for loop if available and</span>
<a name="l01228"></a>01228 <span class="comment">                 print cb id */</span>
<a name="l01229"></a>01229               <span class="keywordflow">if</span> (attr != NULL)
<a name="l01230"></a>01230                 fprintf (<a class="code" href="l__softpipe_8c.html#b31a94b2b54c2bff51947401462afb8a">spill_statfile</a>,
<a name="l01231"></a>01231                          <span class="stringliteral">"Spill_stats_and_code_size_for_loop_on_line: "</span>
<a name="l01232"></a>01232                          ITintmaxformat <span class="stringliteral">"\n"</span>, attr-&gt;field[1]-&gt;value.i);
<a name="l01233"></a>01233               <span class="keywordflow">else</span>
<a name="l01234"></a>01234                 fprintf (spill_statfile,
<a name="l01235"></a>01235                          <span class="stringliteral">"Spill_stats_and_code_size_for_loop_on_line: %d\n"</span>,
<a name="l01236"></a>01236                          0);
<a name="l01237"></a>01237               fprintf (spill_statfile, <span class="stringliteral">"Cb: %d\n"</span>, cb-&gt;id);
<a name="l01238"></a>01238               fprintf (spill_statfile, <span class="stringliteral">"Function: %s\n"</span>, fn-&gt;name);
<a name="l01239"></a>01239               <span class="keywordflow">if</span> (has_rem_loop)
<a name="l01240"></a>01240                 {
<a name="l01241"></a>01241                   fprintf (spill_statfile, <span class="stringliteral">"Has_remainder_loop: %d\n"</span>, 1);
<a name="l01242"></a>01242                   <span class="keywordflow">if</span> (reroll)
<a name="l01243"></a>01243                     fprintf (spill_statfile, <span class="stringliteral">"Reroll: %d\n"</span>, 1);
<a name="l01244"></a>01244                   <span class="keywordflow">else</span>
<a name="l01245"></a>01245                     fprintf (spill_statfile, <span class="stringliteral">"Reroll: %d\n"</span>, 0);
<a name="l01246"></a>01246                 }
<a name="l01247"></a>01247               <span class="keywordflow">else</span>
<a name="l01248"></a>01248                 {
<a name="l01249"></a>01249                   fprintf (spill_statfile, <span class="stringliteral">"Has_remainder_loop: %d\n"</span>, 0);
<a name="l01250"></a>01250                   fprintf (spill_statfile, <span class="stringliteral">"Reroll: %d\n"</span>, 0);
<a name="l01251"></a>01251                 }
<a name="l01252"></a>01252               fprintf (spill_statfile, <span class="stringliteral">"code_size: %d\n"</span>, num_opers);
<a name="l01253"></a>01253               fprintf (spill_statfile, <span class="stringliteral">"rem_code_size: %d\n"</span>, rem_num_opers);
<a name="l01254"></a>01254               fprintf (spill_statfile, <span class="stringliteral">"reroll_code_size: %d\n"</span>,
<a name="l01255"></a>01255                        reroll_num_opers);
<a name="l01256"></a>01256               fprintf (spill_statfile, <span class="stringliteral">"ko_code_size: %d\n"</span>, ko_num_opers);
<a name="l01257"></a>01257               fprintf (spill_statfile, <span class="stringliteral">"rem_ko_code_size: %d\n"</span>,
<a name="l01258"></a>01258                        rem_ko_num_opers);
<a name="l01259"></a>01259               fprintf (spill_statfile, <span class="stringliteral">"reroll_ko_code_size: %d\n"</span>,
<a name="l01260"></a>01260                        reroll_ko_num_opers);
<a name="l01261"></a>01261               fprintf (spill_statfile, <span class="stringliteral">"int_flt_dbl_spills: %d %d %d\n"</span>,
<a name="l01262"></a>01262                        num_int_spills, num_flt_spills, num_dbl_spills);
<a name="l01263"></a>01263             }
<a name="l01264"></a>01264         }
<a name="l01265"></a>01265     }
<a name="l01266"></a>01266 
<a name="l01267"></a>01267   <span class="keywordflow">if</span> (<a class="code" href="l__pipe__util_8c.html#e2d1368da174d6c3c8b7ec7d1cbbf44e">Lpipe_add_spill_attributes</a>)
<a name="l01268"></a>01268     {
<a name="l01269"></a>01269       num_opers = 0;
<a name="l01270"></a>01270       reroll_num_opers = 0;
<a name="l01271"></a>01271       spill_opers = 0;
<a name="l01272"></a>01272       dyn_spill_opers = 0.0;
<a name="l01273"></a>01273       swp = 0;
<a name="l01274"></a>01274       <span class="keywordflow">for</span> (cb = fn-&gt;first_cb; cb != NULL; cb = cb-&gt;next_cb)
<a name="l01275"></a>01275         {
<a name="l01276"></a>01276           <span class="keywordflow">if</span> (L_EXTRACT_BIT_VAL (cb-&gt;flags, L_CB_SOFTPIPE) ||
<a name="l01277"></a>01277               L_find_attr (cb-&gt;attr, <span class="stringliteral">"L_CB_SOFTPIPE"</span>))
<a name="l01278"></a>01278             {
<a name="l01279"></a>01279               swp = 1;
<a name="l01280"></a>01280             }
<a name="l01281"></a>01281           attr = L_find_attr (cb-&gt;attr, <span class="stringliteral">"reroll"</span>);
<a name="l01282"></a>01282           <span class="keywordflow">if</span> (attr != NULL)
<a name="l01283"></a>01283             {
<a name="l01284"></a>01284               reroll_num_opers += attr-&gt;field[0]-&gt;value.i;
<a name="l01285"></a>01285               num_opers += L_cb_size (cb);
<a name="l01286"></a>01286             }
<a name="l01287"></a>01287           <span class="keywordflow">else</span>
<a name="l01288"></a>01288             {
<a name="l01289"></a>01289               reroll_num_opers += L_cb_size (cb);
<a name="l01290"></a>01290               num_opers += L_cb_size (cb);
<a name="l01291"></a>01291             }
<a name="l01292"></a>01292           <span class="keywordflow">for</span> (oper = cb-&gt;first_op; oper != NULL; oper = oper-&gt;next_op)
<a name="l01293"></a>01293             {
<a name="l01294"></a>01294               <span class="keywordflow">if</span> (L_EXTRACT_BIT_VAL (oper-&gt;flags, L_OPER_SPILL_CODE))
<a name="l01295"></a>01295                 {
<a name="l01296"></a>01296                   spill_opers++;
<a name="l01297"></a>01297                   dyn_spill_opers += oper-&gt;weight;
<a name="l01298"></a>01298                 }
<a name="l01299"></a>01299             }
<a name="l01300"></a>01300         }
<a name="l01301"></a>01301 
<a name="l01302"></a>01302       fprintf (<a class="code" href="l__softpipe_8c.html#05e5e553ea7e96a23f4379f954ce70bb">code_statfile</a>, <span class="stringliteral">"\n"</span>);
<a name="l01303"></a>01303       fprintf (<a class="code" href="l__softpipe_8c.html#05e5e553ea7e96a23f4379f954ce70bb">code_statfile</a>, <span class="stringliteral">"Function: %s\n"</span>, fn-&gt;name);
<a name="l01304"></a>01304       fprintf (<a class="code" href="l__softpipe_8c.html#05e5e553ea7e96a23f4379f954ce70bb">code_statfile</a>, <span class="stringliteral">"Total_code_size: %d\n"</span>, num_opers);
<a name="l01305"></a>01305       fprintf (<a class="code" href="l__softpipe_8c.html#05e5e553ea7e96a23f4379f954ce70bb">code_statfile</a>, <span class="stringliteral">"Total_reroll_code_size: %d\n"</span>,
<a name="l01306"></a>01306                reroll_num_opers);
<a name="l01307"></a>01307 
<a name="l01308"></a>01308       <span class="keywordflow">if</span> (swp)
<a name="l01309"></a>01309         {
<a name="l01310"></a>01310           fprintf (<a class="code" href="l__softpipe_8c.html#6124881d1ab46cfbcebdfa6852499434">swp_code_statfile</a>, <span class="stringliteral">"\n"</span>);
<a name="l01311"></a>01311           fprintf (swp_code_statfile, <span class="stringliteral">"Function: %s\n"</span>, fn-&gt;name);
<a name="l01312"></a>01312           fprintf (swp_code_statfile, <span class="stringliteral">"Total_code_size: %d\n"</span>, num_opers);
<a name="l01313"></a>01313           fprintf (swp_code_statfile, <span class="stringliteral">"Total_reroll_code_size: %d\n"</span>,
<a name="l01314"></a>01314                    reroll_num_opers);
<a name="l01315"></a>01315         }
<a name="l01316"></a>01316     }
<a name="l01317"></a>01317 }
<a name="l01318"></a>01318 
<a name="l01319"></a>01319 
<a name="l01320"></a>01320 <span class="comment">/* This assumes the impact architecture's register file model */</span>
<a name="l01321"></a>01321 <span class="keywordtype">void</span>
<a name="l01322"></a><a class="code" href="l__softpipe_8h.html#543bf3b6c57a16d1555f49e4645742bc">01322</a> <a class="code" href="l__softpipe_8c.html#432bc19bba68265dd93532edc814fcff">Lpipe_compute_reg_pressure</a> (L_Func * fn)
<a name="l01323"></a>01323 {
<a name="l01324"></a>01324   Set int_regs = 0;
<a name="l01325"></a>01325   Set flt_regs = 0;
<a name="l01326"></a>01326   Set inv_int_regs = 0;
<a name="l01327"></a>01327   Set inv_flt_regs = 0;
<a name="l01328"></a>01328   Set var_int_regs = 0;
<a name="l01329"></a>01329   Set var_flt_regs = 0;
<a name="l01330"></a>01330   Set rem_int_regs = 0;
<a name="l01331"></a>01331   Set reroll_int_regs = 0;
<a name="l01332"></a>01332   Set func_int_regs = 0;
<a name="l01333"></a>01333   Set func_reroll_int_regs = 0;
<a name="l01334"></a>01334   L_Inner_Loop *loop;
<a name="l01335"></a>01335   L_Oper *oper;
<a name="l01336"></a>01336   L_Operand *dest;
<a name="l01337"></a>01337   L_Operand *src;
<a name="l01338"></a>01338   <span class="keywordtype">int</span> i;
<a name="l01339"></a>01339   <span class="keywordtype">int</span> num_int_regs;
<a name="l01340"></a>01340   <span class="keywordtype">int</span> num_rem_int_regs;
<a name="l01341"></a>01341   <span class="keywordtype">int</span> num_reroll_int_regs;
<a name="l01342"></a>01342   <span class="keywordtype">int</span> num_func_int_regs;
<a name="l01343"></a>01343   <span class="keywordtype">int</span> num_func_reroll_int_regs;
<a name="l01344"></a>01344   <span class="keywordtype">int</span> num_flt_regs;
<a name="l01345"></a>01345   <span class="keywordtype">int</span> num_inv_int_regs;
<a name="l01346"></a>01346   <span class="keywordtype">int</span> num_inv_flt_regs;
<a name="l01347"></a>01347   <span class="keywordtype">int</span> num_var_int_regs;
<a name="l01348"></a>01348   <span class="keywordtype">int</span> num_var_flt_regs;
<a name="l01349"></a>01349   L_Attr *attr;
<a name="l01350"></a>01350   <span class="keywordtype">int</span> has_rem_loop;
<a name="l01351"></a>01351   L_Cb *cb = NULL, *next_cb = NULL;
<a name="l01352"></a>01352   <span class="keywordtype">int</span> rem_loop_found;
<a name="l01353"></a>01353   <span class="keywordtype">int</span> swp;
<a name="l01354"></a>01354   <span class="keywordtype">int</span> num_live;
<a name="l01355"></a>01355   <span class="keywordtype">int</span> max_live;
<a name="l01356"></a>01356   <span class="keywordtype">int</span> rem_max_live;
<a name="l01357"></a>01357   <span class="keywordtype">int</span> reroll_max_live;
<a name="l01358"></a>01358   <span class="keywordtype">int</span> *int_reg_array;
<a name="l01359"></a>01359   Set live_reg_set = 0;
<a name="l01360"></a>01360 
<a name="l01361"></a>01361   <span class="keywordflow">if</span> (!<a class="code" href="l__pipe__util_8c.html#05b449c92ca8c59d61db6054cd56e7ee">Lpipe_compute_loop_reg_pressure</a>)
<a name="l01362"></a>01362     <span class="keywordflow">return</span>;
<a name="l01363"></a>01363 
<a name="l01364"></a>01364   L_inner_loop_detection (fn, 0);
<a name="l01365"></a>01365   L_do_flow_analysis (fn, LIVE_VARIABLE);
<a name="l01366"></a>01366 
<a name="l01367"></a>01367   <span class="keywordflow">for</span> (loop = fn-&gt;first_inner_loop; loop; loop = loop-&gt;next_inner_loop)
<a name="l01368"></a>01368     {
<a name="l01369"></a>01369       <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a> = loop-&gt;cb;
<a name="l01370"></a>01370 
<a name="l01371"></a>01371       <span class="keywordflow">if</span> (!L_EXTRACT_BIT_VAL (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;flags, L_CB_SOFTPIPE) &amp;&amp;
<a name="l01372"></a>01372           !L_find_attr (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr, <span class="stringliteral">"L_CB_SOFTPIPE"</span>))
<a name="l01373"></a>01373         <span class="keywordflow">continue</span>;
<a name="l01374"></a>01374 
<a name="l01375"></a>01375 <span class="preprocessor">#ifdef LP64_ARCHITECTURE</span>
<a name="l01376"></a>01376 <span class="preprocessor"></span>      has_rem_loop = (int)((<span class="keywordtype">long</span>)L_find_attr (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr,
<a name="l01377"></a>01377                                               <span class="stringliteral">"has_rem_loop"</span>));
<a name="l01378"></a>01378 <span class="preprocessor">#else</span>
<a name="l01379"></a>01379 <span class="preprocessor"></span>      has_rem_loop = (int) L_find_attr (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr, <span class="stringliteral">"has_rem_loop"</span>);
<a name="l01380"></a>01380 <span class="preprocessor">#endif</span>
<a name="l01381"></a>01381 <span class="preprocessor"></span>
<a name="l01382"></a>01382       <span class="keywordflow">for</span> (oper = <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;first_op; oper != NULL; oper = oper-&gt;next_op)
<a name="l01383"></a>01383         {
<a name="l01384"></a>01384           <span class="keywordflow">for</span> (i = 0; i &lt; L_max_dest_operand; i++)
<a name="l01385"></a>01385             {
<a name="l01386"></a>01386               dest = oper-&gt;dest[i];
<a name="l01387"></a>01387               if (L_is_register (dest))
<a name="l01388"></a>01388                 {
<a name="l01389"></a>01389                   <span class="keywordflow">if</span> (L_is_ctype_integer (dest))
<a name="l01390"></a>01390                     {
<a name="l01391"></a>01391                       int_regs = Set_add (int_regs, dest-&gt;value.r);
<a name="l01392"></a>01392                       var_int_regs = Set_add (var_int_regs, dest-&gt;value.r);
<a name="l01393"></a>01393                     }
<a name="l01394"></a>01394                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (L_is_ctype_flt (dest))
<a name="l01395"></a>01395                     {
<a name="l01396"></a>01396                       flt_regs = Set_add (flt_regs, dest-&gt;value.r);
<a name="l01397"></a>01397                       var_flt_regs = Set_add (var_flt_regs, dest-&gt;value.r);
<a name="l01398"></a>01398                     }
<a name="l01399"></a>01399                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (L_is_ctype_dbl (dest))
<a name="l01400"></a>01400                     {
<a name="l01401"></a>01401                       flt_regs = Set_add (flt_regs, dest-&gt;value.r);
<a name="l01402"></a>01402                       flt_regs = Set_add (flt_regs, dest-&gt;value.r + 1);
<a name="l01403"></a>01403                       var_flt_regs = Set_add (var_flt_regs, dest-&gt;value.r);
<a name="l01404"></a>01404                       var_flt_regs =
<a name="l01405"></a>01405                         Set_add (var_flt_regs, dest-&gt;value.r + 1);
<a name="l01406"></a>01406                     }
<a name="l01407"></a>01407                 }
<a name="l01408"></a>01408             }
<a name="l01409"></a>01409 
<a name="l01410"></a>01410           <span class="keywordflow">for</span> (i = 0; i &lt; L_max_src_operand; i++)
<a name="l01411"></a>01411             {
<a name="l01412"></a>01412               src = oper-&gt;src[i];
<a name="l01413"></a>01413               if (L_is_register (src))
<a name="l01414"></a>01414                 {
<a name="l01415"></a>01415                   <span class="keywordflow">if</span> (L_is_ctype_integer (src))
<a name="l01416"></a>01416                     {
<a name="l01417"></a>01417                       int_regs = Set_add (int_regs, src-&gt;value.r);
<a name="l01418"></a>01418                     }
<a name="l01419"></a>01419                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (L_is_ctype_flt (src))
<a name="l01420"></a>01420                     {
<a name="l01421"></a>01421                       flt_regs = Set_add (flt_regs, src-&gt;value.r);
<a name="l01422"></a>01422                     }
<a name="l01423"></a>01423                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (L_is_ctype_dbl (src))
<a name="l01424"></a>01424                     {
<a name="l01425"></a>01425                       flt_regs = Set_add (flt_regs, src-&gt;value.r);
<a name="l01426"></a>01426                       flt_regs = Set_add (flt_regs, src-&gt;value.r + 1);
<a name="l01427"></a>01427                     }
<a name="l01428"></a>01428                 }
<a name="l01429"></a>01429             }
<a name="l01430"></a>01430         }
<a name="l01431"></a>01431 
<a name="l01432"></a>01432       max_live = 0;
<a name="l01433"></a>01433       num_int_regs = Set_size (int_regs);
<a name="l01434"></a>01434       int_reg_array = (<span class="keywordtype">int</span> *) calloc (num_int_regs, <span class="keyword">sizeof</span> (<span class="keywordtype">int</span>));
<a name="l01435"></a>01435       Set_2array (int_regs, int_reg_array);
<a name="l01436"></a>01436       <span class="keywordflow">for</span> (oper = <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;first_op; oper != NULL; oper = oper-&gt;next_op)
<a name="l01437"></a>01437         {
<a name="l01438"></a>01438           num_live = 0;
<a name="l01439"></a>01439           live_reg_set = L_get_oper_OUT_set (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>, oper, BOTH_PATHS);
<a name="l01440"></a>01440           <span class="keywordflow">for</span> (i = 0; i &lt; num_int_regs; i++)
<a name="l01441"></a>01441             {
<a name="l01442"></a>01442               <span class="keywordflow">if</span> (Set_in (live_reg_set, L_REG_INDEX (int_reg_array[i])))
<a name="l01443"></a>01443                 {
<a name="l01444"></a>01444                   num_live++;
<a name="l01445"></a>01445                 }
<a name="l01446"></a>01446             }
<a name="l01447"></a>01447           <span class="keywordflow">if</span> (num_live &gt; max_live)
<a name="l01448"></a>01448             {
<a name="l01449"></a>01449               max_live = num_live;
<a name="l01450"></a>01450             }
<a name="l01451"></a>01451         }
<a name="l01452"></a>01452       Lcode_free (int_reg_array);
<a name="l01453"></a>01453 
<a name="l01454"></a>01454       rem_max_live = 0;
<a name="l01455"></a>01455       reroll_max_live = 0;
<a name="l01456"></a>01456 
<a name="l01457"></a>01457       <span class="keywordflow">if</span> (has_rem_loop)
<a name="l01458"></a>01458         {
<a name="l01459"></a>01459 
<a name="l01460"></a>01460           rem_loop_found = 0;
<a name="l01461"></a>01461           <span class="keywordflow">for</span> (next_cb = <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;next_cb; next_cb != NULL;
<a name="l01462"></a>01462                next_cb = next_cb-&gt;next_cb)
<a name="l01463"></a>01463             {
<a name="l01464"></a>01464               attr = L_find_attr (next_cb-&gt;attr, <span class="stringliteral">"rem_loop"</span>);
<a name="l01465"></a>01465               <span class="keywordflow">if</span> (attr != NULL &amp;&amp; attr-&gt;field[0]-&gt;value.i == <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;id)
<a name="l01466"></a>01466                 {
<a name="l01467"></a>01467                   rem_loop_found = 1;
<a name="l01468"></a>01468                   <span class="keywordflow">break</span>;
<a name="l01469"></a>01469                 }
<a name="l01470"></a>01470             }
<a name="l01471"></a>01471 
<a name="l01472"></a>01472           <span class="keywordflow">if</span> (!rem_loop_found)
<a name="l01473"></a>01473             {
<a name="l01474"></a>01474               <span class="comment">/* ITI/MCM Certain optimizations move the rem_loop up</span>
<a name="l01475"></a>01475 <span class="comment">                 above the rem_epilogue and modulo scheduled loop.</span>
<a name="l01476"></a>01476 <span class="comment">                 Since this is for statistics only, skip the remaining</span>
<a name="l01477"></a>01477 <span class="comment">                 code in the has_rem_loop if conditional. */</span>
<a name="l01478"></a>01478 <span class="preprocessor">#if 0</span>
<a name="l01479"></a>01479 <span class="preprocessor"></span>              L_punt (<span class="stringliteral">"Lpipe_compute_reg_pressure: "</span>
<a name="l01480"></a>01480                       <span class="stringliteral">"could not find remainder loop. "</span>
<a name="l01481"></a>01481                       <span class="stringliteral">"cb: %d, function: %s\n"</span>, <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;id, fn-&gt;name);
<a name="l01482"></a>01482 <span class="preprocessor">#endif</span>
<a name="l01483"></a>01483 <span class="preprocessor"></span>              has_rem_loop = 0;
<a name="l01484"></a>01484             }
<a name="l01485"></a>01485         }
<a name="l01486"></a>01486 
<a name="l01487"></a>01487       <span class="keywordflow">if</span> (has_rem_loop)
<a name="l01488"></a>01488         {
<a name="l01489"></a>01489           <span class="keywordflow">for</span> (oper = next_cb-&gt;first_op; oper != NULL; oper = oper-&gt;next_op)
<a name="l01490"></a>01490             {
<a name="l01491"></a>01491               <span class="keywordflow">for</span> (i = 0; i &lt; L_max_dest_operand; i++)
<a name="l01492"></a>01492                 {
<a name="l01493"></a>01493                   dest = oper-&gt;dest[i];
<a name="l01494"></a>01494                   if (L_is_register (dest))
<a name="l01495"></a>01495                     {
<a name="l01496"></a>01496                       <span class="keywordflow">if</span> (L_is_ctype_integer (dest))
<a name="l01497"></a>01497                         {
<a name="l01498"></a>01498                           rem_int_regs =
<a name="l01499"></a>01499                             Set_add (rem_int_regs, dest-&gt;value.r);
<a name="l01500"></a>01500                         }
<a name="l01501"></a>01501                     }
<a name="l01502"></a>01502                 }
<a name="l01503"></a>01503 
<a name="l01504"></a>01504               <span class="keywordflow">for</span> (i = 0; i &lt; L_max_src_operand; i++)
<a name="l01505"></a>01505                 {
<a name="l01506"></a>01506                   src = oper-&gt;src[i];
<a name="l01507"></a>01507                   if (L_is_register (src))
<a name="l01508"></a>01508                     {
<a name="l01509"></a>01509                       <span class="keywordflow">if</span> (L_is_ctype_integer (src))
<a name="l01510"></a>01510                         {
<a name="l01511"></a>01511                           rem_int_regs = Set_add (rem_int_regs, src-&gt;value.r);
<a name="l01512"></a>01512                         }
<a name="l01513"></a>01513                     }
<a name="l01514"></a>01514                 }
<a name="l01515"></a>01515             }
<a name="l01516"></a>01516 
<a name="l01517"></a>01517           rem_max_live = 0;
<a name="l01518"></a>01518           num_int_regs = Set_size (rem_int_regs);
<a name="l01519"></a>01519           int_reg_array = (<span class="keywordtype">int</span> *) calloc (num_int_regs, <span class="keyword">sizeof</span> (<span class="keywordtype">int</span>));
<a name="l01520"></a>01520           Set_2array (rem_int_regs, int_reg_array);
<a name="l01521"></a>01521           <span class="keywordflow">for</span> (oper = next_cb-&gt;first_op; oper != NULL; oper = oper-&gt;next_op)
<a name="l01522"></a>01522             {
<a name="l01523"></a>01523               num_live = 0;
<a name="l01524"></a>01524               live_reg_set = L_get_oper_OUT_set (next_cb, oper, BOTH_PATHS);
<a name="l01525"></a>01525               <span class="keywordflow">for</span> (i = 0; i &lt; num_int_regs; i++)
<a name="l01526"></a>01526                 {
<a name="l01527"></a>01527                   <span class="keywordflow">if</span> (Set_in (live_reg_set, L_REG_INDEX (int_reg_array[i])))
<a name="l01528"></a>01528                     {
<a name="l01529"></a>01529                       num_live++;
<a name="l01530"></a>01530                     }
<a name="l01531"></a>01531                 }
<a name="l01532"></a>01532               <span class="keywordflow">if</span> (num_live &gt; rem_max_live)
<a name="l01533"></a>01533                 {
<a name="l01534"></a>01534                   rem_max_live = num_live;
<a name="l01535"></a>01535                 }
<a name="l01536"></a>01536             }
<a name="l01537"></a>01537           Lcode_free (int_reg_array);
<a name="l01538"></a>01538 
<a name="l01539"></a>01539           attr = L_find_attr (next_cb-&gt;attr, <span class="stringliteral">"reroll"</span>);
<a name="l01540"></a>01540           <span class="keywordflow">if</span> (attr == NULL)
<a name="l01541"></a>01541             {
<a name="l01542"></a>01542               reroll_int_regs = Set_copy (rem_int_regs);
<a name="l01543"></a>01543               reroll_max_live = rem_max_live;
<a name="l01544"></a>01544             }
<a name="l01545"></a>01545         }
<a name="l01546"></a>01546 
<a name="l01547"></a>01547       rem_int_regs = Set_union_acc (rem_int_regs, int_regs);
<a name="l01548"></a>01548       rem_max_live = IMPACT_MAX (rem_max_live, max_live);
<a name="l01549"></a>01549       reroll_int_regs = Set_union_acc (reroll_int_regs, int_regs);
<a name="l01550"></a>01550       reroll_max_live = IMPACT_MAX (reroll_max_live, max_live);
<a name="l01551"></a>01551 
<a name="l01552"></a>01552       inv_int_regs = Set_subtract (int_regs, var_int_regs);
<a name="l01553"></a>01553       inv_flt_regs = Set_subtract (flt_regs, var_flt_regs);
<a name="l01554"></a>01554 
<a name="l01555"></a>01555       num_int_regs = Set_size (int_regs);
<a name="l01556"></a>01556       num_rem_int_regs = Set_size (rem_int_regs);
<a name="l01557"></a>01557       num_reroll_int_regs = Set_size (reroll_int_regs);
<a name="l01558"></a>01558       num_flt_regs = Set_size (flt_regs);
<a name="l01559"></a>01559       num_var_int_regs = Set_size (var_int_regs);
<a name="l01560"></a>01560       num_var_flt_regs = Set_size (var_flt_regs);
<a name="l01561"></a>01561       num_inv_int_regs = Set_size (inv_int_regs);
<a name="l01562"></a>01562       num_inv_flt_regs = Set_size (inv_flt_regs);
<a name="l01563"></a>01563 
<a name="l01564"></a>01564       fprintf (<a class="code" href="l__softpipe_8c.html#9f9788ffccb227a45934435833fe651e">reg_statfile</a>, <span class="stringliteral">"\n"</span>);
<a name="l01565"></a>01565       attr = L_find_attr (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr, <span class="stringliteral">"LOOP"</span>);
<a name="l01566"></a>01566       <span class="comment">/* print source line number for loop if available and print cb id */</span>
<a name="l01567"></a>01567       <span class="keywordflow">if</span> (attr != NULL)
<a name="l01568"></a>01568         fprintf (<a class="code" href="l__softpipe_8c.html#9f9788ffccb227a45934435833fe651e">reg_statfile</a>,
<a name="l01569"></a>01569                  <span class="stringliteral">"Register_pressure_for_loop_on_line: "</span> ITintmaxformat <span class="stringliteral">"\n"</span>,
<a name="l01570"></a>01570                  attr-&gt;field[1]-&gt;value.i);
<a name="l01571"></a>01571       <span class="keywordflow">else</span>
<a name="l01572"></a>01572         fprintf (reg_statfile, <span class="stringliteral">"Register_pressure_for_loop_on_line: %d\n"</span>, 0);
<a name="l01573"></a>01573       fprintf (reg_statfile, <span class="stringliteral">"Cb: %d\n"</span>, <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;id);
<a name="l01574"></a>01574       fprintf (reg_statfile, <span class="stringliteral">"Function: %s\n"</span>, fn-&gt;name);
<a name="l01575"></a>01575       <span class="keywordflow">if</span> (has_rem_loop)
<a name="l01576"></a>01576         {
<a name="l01577"></a>01577           fprintf (reg_statfile, <span class="stringliteral">"Has_remainder_loop: %d\n"</span>, 1);
<a name="l01578"></a>01578           attr = L_find_attr (next_cb-&gt;attr, <span class="stringliteral">"reroll"</span>);
<a name="l01579"></a>01579           <span class="keywordflow">if</span> (attr != NULL)
<a name="l01580"></a>01580             fprintf (reg_statfile, <span class="stringliteral">"Reroll: %d\n"</span>, 1);
<a name="l01581"></a>01581           <span class="keywordflow">else</span>
<a name="l01582"></a>01582             fprintf (reg_statfile, <span class="stringliteral">"Reroll: %d\n"</span>, 0);
<a name="l01583"></a>01583         }
<a name="l01584"></a>01584       <span class="keywordflow">else</span>
<a name="l01585"></a>01585         {
<a name="l01586"></a>01586           fprintf (reg_statfile, <span class="stringliteral">"Has_remainder_loop: %d\n"</span>, 0);
<a name="l01587"></a>01587           fprintf (reg_statfile, <span class="stringliteral">"Reroll: %d\n"</span>, 0);
<a name="l01588"></a>01588         }
<a name="l01589"></a>01589 <span class="comment">/*</span>
<a name="l01590"></a>01590 <span class="comment">      fprintf(reg_statfile,"Number_of_variant_int_regs: %d\n", </span>
<a name="l01591"></a>01591 <span class="comment">        num_var_int_regs);</span>
<a name="l01592"></a>01592 <span class="comment">      fprintf(reg_statfile,"Number_of_variant_flt_regs: %d\n", </span>
<a name="l01593"></a>01593 <span class="comment">        num_var_flt_regs);</span>
<a name="l01594"></a>01594 <span class="comment">      fprintf(reg_statfile,"Number_of_invariant_int_regs: %d\n", </span>
<a name="l01595"></a>01595 <span class="comment">        num_inv_int_regs);</span>
<a name="l01596"></a>01596 <span class="comment">      fprintf(reg_statfile,"Number_of_invariant_flt_regs: %d\n", </span>
<a name="l01597"></a>01597 <span class="comment">        num_inv_flt_regs);</span>
<a name="l01598"></a>01598 <span class="comment">      fprintf(reg_statfile,"Total_number_of_flt_regs: %d\n", </span>
<a name="l01599"></a>01599 <span class="comment">        num_flt_regs);</span>
<a name="l01600"></a>01600 <span class="comment">*/</span>
<a name="l01601"></a>01601       fprintf (reg_statfile, <span class="stringliteral">"Total_number_of_int_regs: %d\n"</span>, num_int_regs);
<a name="l01602"></a>01602       fprintf (reg_statfile, <span class="stringliteral">"Total_number_of_rem_int_regs: %d\n"</span>,
<a name="l01603"></a>01603                num_rem_int_regs);
<a name="l01604"></a>01604       fprintf (reg_statfile, <span class="stringliteral">"Total_number_of_reroll_int_regs: %d\n"</span>,
<a name="l01605"></a>01605                num_reroll_int_regs);
<a name="l01606"></a>01606       fprintf (reg_statfile, <span class="stringliteral">"Max_live: %d\n"</span>, max_live);
<a name="l01607"></a>01607       fprintf (reg_statfile, <span class="stringliteral">"Max_live_rem: %d\n"</span>, rem_max_live);
<a name="l01608"></a>01608       fprintf (reg_statfile, <span class="stringliteral">"Max_live_reroll: %d\n"</span>, reroll_max_live);
<a name="l01609"></a>01609 
<a name="l01610"></a>01610       attr = L_new_attr (<span class="stringliteral">"var_inv_int_regs"</span>, 2);
<a name="l01611"></a>01611       L_set_int_attr_field (attr, 0, num_var_int_regs);
<a name="l01612"></a>01612       L_set_int_attr_field (attr, 1, num_inv_int_regs);
<a name="l01613"></a>01613       <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr = L_concat_attr (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr, attr);
<a name="l01614"></a>01614       attr = L_new_attr (<span class="stringliteral">"var_inv_flt_regs"</span>, 2);
<a name="l01615"></a>01615       L_set_int_attr_field (attr, 0, num_var_flt_regs);
<a name="l01616"></a>01616       L_set_int_attr_field (attr, 1, num_inv_flt_regs);
<a name="l01617"></a>01617       <a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr = L_concat_attr (<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>-&gt;attr, attr);
<a name="l01618"></a>01618 
<a name="l01619"></a>01619       int_regs = Set_dispose (int_regs);
<a name="l01620"></a>01620       flt_regs = Set_dispose (flt_regs);
<a name="l01621"></a>01621       var_int_regs = Set_dispose (var_int_regs);
<a name="l01622"></a>01622       var_flt_regs = Set_dispose (var_flt_regs);
<a name="l01623"></a>01623       inv_int_regs = Set_dispose (inv_int_regs);
<a name="l01624"></a>01624       inv_flt_regs = Set_dispose (inv_flt_regs);
<a name="l01625"></a>01625       rem_int_regs = Set_dispose (rem_int_regs);
<a name="l01626"></a>01626       reroll_int_regs = Set_dispose (reroll_int_regs);
<a name="l01627"></a>01627     }
<a name="l01628"></a>01628 
<a name="l01629"></a>01629   swp = 0;
<a name="l01630"></a>01630   <span class="keywordflow">for</span> (cb = fn-&gt;first_cb; cb != NULL; cb = cb-&gt;next_cb)
<a name="l01631"></a>01631     {
<a name="l01632"></a>01632       <span class="keywordflow">if</span> (L_EXTRACT_BIT_VAL (cb-&gt;flags, L_CB_SOFTPIPE) ||
<a name="l01633"></a>01633           L_find_attr (cb-&gt;attr, <span class="stringliteral">"L_CB_SOFTPIPE"</span>))
<a name="l01634"></a>01634         {
<a name="l01635"></a>01635           swp = 1;
<a name="l01636"></a>01636         }
<a name="l01637"></a>01637 
<a name="l01638"></a>01638       attr = L_find_attr (cb-&gt;attr, <span class="stringliteral">"reroll"</span>);
<a name="l01639"></a>01639 
<a name="l01640"></a>01640       <span class="keywordflow">for</span> (oper = cb-&gt;first_op; oper != NULL; oper = oper-&gt;next_op)
<a name="l01641"></a>01641         {
<a name="l01642"></a>01642           <span class="keywordflow">for</span> (i = 0; i &lt; L_max_dest_operand; i++)
<a name="l01643"></a>01643             {
<a name="l01644"></a>01644               dest = oper-&gt;dest[i];
<a name="l01645"></a>01645               if (L_is_register (dest))
<a name="l01646"></a>01646                 {
<a name="l01647"></a>01647                   <span class="keywordflow">if</span> (L_is_ctype_integer (dest))
<a name="l01648"></a>01648                     {
<a name="l01649"></a>01649                       func_int_regs = Set_add (func_int_regs, dest-&gt;value.r);
<a name="l01650"></a>01650                       if (attr == NULL)
<a name="l01651"></a>01651                         {
<a name="l01652"></a>01652                           func_reroll_int_regs =
<a name="l01653"></a>01653                             Set_add (func_reroll_int_regs, dest-&gt;value.r);
<a name="l01654"></a>01654                         }
<a name="l01655"></a>01655                     }
<a name="l01656"></a>01656                 }
<a name="l01657"></a>01657             }
<a name="l01658"></a>01658 
<a name="l01659"></a>01659           <span class="keywordflow">for</span> (i = 0; i &lt; L_max_src_operand; i++)
<a name="l01660"></a>01660             {
<a name="l01661"></a>01661               src = oper-&gt;src[i];
<a name="l01662"></a>01662               if (L_is_register (src))
<a name="l01663"></a>01663                 {
<a name="l01664"></a>01664                   <span class="keywordflow">if</span> (L_is_ctype_integer (src))
<a name="l01665"></a>01665                     {
<a name="l01666"></a>01666                       func_int_regs = Set_add (func_int_regs, src-&gt;value.r);
<a name="l01667"></a>01667                       if (attr == NULL)
<a name="l01668"></a>01668                         {
<a name="l01669"></a>01669                           func_reroll_int_regs =
<a name="l01670"></a>01670                             Set_add (func_reroll_int_regs, src-&gt;value.r);
<a name="l01671"></a>01671                         }
<a name="l01672"></a>01672                     }
<a name="l01673"></a>01673                 }
<a name="l01674"></a>01674             }
<a name="l01675"></a>01675         }
<a name="l01676"></a>01676     }
<a name="l01677"></a>01677 
<a name="l01678"></a>01678   <span class="keywordflow">if</span> (swp)
<a name="l01679"></a>01679     {
<a name="l01680"></a>01680       num_func_int_regs = Set_size (func_int_regs);
<a name="l01681"></a>01681       num_func_reroll_int_regs = Set_size (func_reroll_int_regs);
<a name="l01682"></a>01682       fprintf (<a class="code" href="l__softpipe_8c.html#66928bb443a445b2b093b1082d083379">func_reg_statfile</a>, <span class="stringliteral">"\n"</span>);
<a name="l01683"></a>01683       fprintf (<a class="code" href="l__softpipe_8c.html#66928bb443a445b2b093b1082d083379">func_reg_statfile</a>, <span class="stringliteral">"Register_usage_for_function: %s\n"</span>,
<a name="l01684"></a>01684                fn-&gt;name);
<a name="l01685"></a>01685       fprintf (<a class="code" href="l__softpipe_8c.html#66928bb443a445b2b093b1082d083379">func_reg_statfile</a>, <span class="stringliteral">"Total_number_of_int_regs: %d\n"</span>,
<a name="l01686"></a>01686                num_func_int_regs);
<a name="l01687"></a>01687       fprintf (<a class="code" href="l__softpipe_8c.html#66928bb443a445b2b093b1082d083379">func_reg_statfile</a>, <span class="stringliteral">"Total_number_of_reroll_int_regs: %d\n"</span>,
<a name="l01688"></a>01688                num_func_reroll_int_regs);
<a name="l01689"></a>01689     }
<a name="l01690"></a>01690 
<a name="l01691"></a>01691   func_int_regs = Set_dispose (func_int_regs);
<a name="l01692"></a>01692   func_reroll_int_regs = Set_dispose (func_reroll_int_regs);
<a name="l01693"></a>01693 }
<a name="l01694"></a>01694 
<a name="l01695"></a>01695 
<a name="l01696"></a>01696 <span class="preprocessor">#if 0</span>
<a name="l01697"></a>01697 <span class="preprocessor"></span>
<a name="l01698"></a>01698 <span class="comment">/* Fill delay slot for loop back branch in kernel for remainder loop</span>
<a name="l01699"></a>01699 <span class="comment">   code schema.  Only used when pipelining for a real PA processor.  </span>
<a name="l01700"></a>01700 <span class="comment">   Called by code generator just before postpass acyclic scheduling. */</span>
<a name="l01701"></a>01701 <span class="keywordtype">void</span>
<a name="l01702"></a>01702 <a class="code" href="l__softpipe_8h.html#9f7e49adda2510d97489e2bfb1644da0">Lpipe_fill_delay_slots</a> (fn)
<a name="l01703"></a>01703      L_Func *fn;
<a name="l01704"></a>01704 {
<a name="l01705"></a>01705   L_Cb *<a class="code" href="l__softpipe_8c.html#91e84fa9645e4d3beb7b8b6c150da74b">header_cb</a>;
<a name="l01706"></a>01706   L_Cb *<a class="code" href="l__softpipe_8c.html#4708e528902bf49b9c374df3e644309d">prologue_cb</a>;
<a name="l01707"></a>01707   L_Oper *oper;
<a name="l01708"></a>01708   L_Oper *new_oper;
<a name="l01709"></a>01709   L_Oper *loop_back_br;
<a name="l01710"></a>01710   L_Attr *attr;
<a name="l01711"></a>01711 
<a name="l01712"></a>01712 
<a name="l01713"></a>01713   <span class="comment">/* Fill delay slot for loop back branch for each software pipelined loop */</span>
<a name="l01714"></a>01714   <span class="keywordflow">for</span> (header_cb = fn-&gt;first_cb; header_cb != NULL;
<a name="l01715"></a>01715        header_cb = header_cb-&gt;next_cb)
<a name="l01716"></a>01716     {
<a name="l01717"></a>01717       <span class="keywordflow">if</span> (L_EXTRACT_BIT_VAL (header_cb-&gt;flags, L_CB_SOFTPIPE))
<a name="l01718"></a>01718         {
<a name="l01719"></a>01719 
<a name="l01720"></a>01720           <span class="comment">/* remove first operation from the kernel and place a copy of</span>
<a name="l01721"></a>01721 <span class="comment">             it and the end of the prologue and after the loop back branch */</span>
<a name="l01722"></a>01722           prologue_cb = header_cb-&gt;prev_cb;
<a name="l01723"></a>01723           loop_back_br = <a class="code" href="l__pipe__util_8c.html#a00a3d794df406f15d3d85b20f483941">Lpipe_find_loop_back_br</a> (fn, header_cb);
<a name="l01724"></a>01724           oper = header_cb-&gt;first_op;
<a name="l01725"></a>01725           L_remove_oper (header_cb, oper);
<a name="l01726"></a>01726           new_oper = L_copy_operation (oper);
<a name="l01727"></a>01727           L_insert_oper_after (header_cb, header_cb-&gt;last_op, oper);
<a name="l01728"></a>01728           L_insert_oper_after (prologue_cb, prologue_cb-&gt;last_op, new_oper);
<a name="l01729"></a>01729           <span class="comment">/* remove attr on new_oper because prologue will be scheduled</span>
<a name="l01730"></a>01730 <span class="comment">             by acyclic scheduler */</span>
<a name="l01731"></a>01731           attr = L_find_attr (new_oper-&gt;attr, <span class="stringliteral">"isl"</span>);
<a name="l01732"></a>01732           new_oper-&gt;attr = L_delete_attr (new_oper-&gt;attr, attr);
<a name="l01733"></a>01733           <span class="comment">/* squash oper if loop back branch not taken */</span>
<a name="l01734"></a>01734           loop_back_br-&gt;flags = L_SET_BIT_FLAG (loop_back_br-&gt;flags,
<a name="l01735"></a>01735                                                 L_OPER_SQUASHING);
<a name="l01736"></a>01736         }
<a name="l01737"></a>01737     }
<a name="l01738"></a>01738 }
<a name="l01739"></a>01739 
<a name="l01740"></a>01740 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Aug 30 17:59:22 2014 for libsoftpipe by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
